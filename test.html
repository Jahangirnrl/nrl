<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMART HOME</title>
<link rel="icon" type="image/x-icon" href="https://jahangirnrl.github.io/nrl/AAT_LOGO2.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
/* Internet Connection Status Styles */
#connectionStatus {
    position: fixed;
    top: 206px;
    left: 50%;
    transform: translateX(-50%);
    padding: 5px 08px;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 300;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    font-family: "Inter", sans-serif;
    letter-spacing: 0.5px;
}

/* Rest of your existing CSS remains the same */
/* ADDED: Branding Header Styles */
.branding-header {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 10px;
    margin-bottom: 05px;
    border-bottom: 1px solid #334155;
    position: relative;
}
.all-caps {
    text-transform: uppercase;
}
.title-case {
    text-transform: capitalize;
}
.branding-logo {
    width: 40px;
    height: 40px;
    margin-right: 12px;
    border-radius: 8px;
    background: linear-gradient(135deg, #38bdf8, #0ea5e9);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #0f172a;
    font-weight: bold;
    font-size: 1.2rem;
}
.branding-name {
    font-size: 1.4rem;
    font-weight: 700;
    color: #38bdf8;
    letter-spacing: 0.5px;
}
/* ADDED: Copyright Footer Styles */
.copyright-footer {
    text-align: center;
    padding: 10px 0;
    margin-top: 100px;
    border-top: 1px solid #334155;
    color: #94a3b8;
    font-size: 0.8rem;
}
/* UPDATED: Full width panel for last update */
.panel-full-width {
    grid-column: 1 / -1;
    background: rgba(30,41,59,0.9); 
    border-radius:10px; 
    padding:10px; 
    text-align:center; 
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
    border: 1px solid #334155;
}
.panel-full-width .label { 
    font-size:0.65rem; 
    color:#94a3b8; 
    margin-bottom:2px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.panel-full-width .value { 
    font-weight:700; 
    font-size:1rem; 
    color:#f1f5f9; 
    overflow: hidden;
    text-overflow: ellipsis;
}
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
body {
    margin:0; padding:0; 
    font-family: "Inter", sans-serif;
    background:#0f172a;
    color:#e2e8f0;
    line-height:1.4;
    font-size: 0.95rem; 
}
#dashboardContainer {
    padding: 10px;
}
/* --- LOGIN SCREEN STYLES --- */
#loginScreen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    box-sizing: border-box;
    text-align: center;
    background: #1e293b; 
}
.login-card {
    background: #0f172a;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    max-width: 350px;
    width: 100%;
}
.login-card h2 {
    color: #38bdf8;
    margin-bottom: 20px;
    font-size: 1.8rem;
}
.login-input {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 1px solid #334155;
    border-radius: 6px;
    background: #1e293b;
    color: #f1f5f9;
    font-size: 1rem;
    box-sizing: border-box;
}
.login-input:focus { outline: none; border-color: #38bdf8; }
.login-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 6px;
    background: #10b981;
    color: #042f2e;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
}
.login-btn:hover { background: #059669; }
#loginError {
    color: #ef4444;
    margin-top: 10px;
    font-size: 0.85rem;
}
/* --- HEADER AND PROFILE MENU STYLES --- */
header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 12px;
    padding: 0 5px; 
    position: relative; 
}
/* UPDATED: Profile menu positioning */
.profile-menu {
    position: absolute;
    right: 10px;
    z-index: 2;
}
.profile-btn {
    background: transparent;
    border: none;
    color: #38bdf8;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 3px;
}
.profile-btn span {
    display: block;
    width: 2px;
    height: 2px;
    background-color: #38bdf8;
    border-radius: 1px;
}
.dropdown-content {
    display: none;
    position: absolute;
    margin-top: 0;
    right: 0;
    background-color: #1e293b;
    min-width: 250px;
    box-shadow: 0 8px 16px 0 rgba(0,0,0,0.4);
    border-radius: 8px;
    z-index: 20;
    padding: 15px;
    border: 1px solid #334155;
    text-align: left;
}
.dropdown-content.show {
    display: block;
}
.dropdown-content p {
    margin: 0 0 15px 0;
    color: #94a3b8;
    font-size: 0.85rem;
    word-break: break-word;
}
.dropdown-btn {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background 0.2s;
    margin-bottom: 10px;
}
.dropdown-btn:last-child {
    margin-bottom: 0;
}
.logout-btn { 
    background: #ef4444;
    color: #0f172a;
}
.logout-btn:hover { background: #b91c1c; }
.restart-btn {
    background: #f59e0b;
    color: #0f172a;
}
.restart-btn:hover { background: #d97706; }
/* NEW: Settings Button */
.settings-btn {
    background: #8b5cf6;
    color: #0f172a;
}
.settings-btn:hover { background: #7c3aed; }
.settings-btn2 {
    background: #228B22;
    color: #0f172a;
}
.settings-btn2:hover { background: #006400; }    
/* NEW: Edit Account Button */
.edit-account-btn {
    background: #0ea5e9;
    color: #0f172a;
}
.edit-account-btn:hover { background: #0284c7; }
/* UPDATED: Header center content */
.header-center-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
}
/* UPDATED: Branding header positioning */
.branding-header {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 20px;
    margin-bottom: 05px;
    border-bottom: 1px solid #334155;
    position: relative;
}
.branding-logo-img {
    width: 45px;
    height: 45px;
    margin-right: 12px;
    border-radius: 10px;
    object-fit: cover;
    background: #0f172a;
    border: 2px solid #334155;
    box-shadow: 0 0 10px rgba(56, 189, 248, 0.4);
}  

/* Facebook-style Tab Navigation - Full Width */
.tab-navigation {
    display: flex;
    background: rgba(15, 23, 42);
    border-radius: 12px;
    padding: 8px;
    margin: 10px 0;
    box-shadow: rgba(15, 23, 42);
    position: relative;
    overflow: hidden;
    width: 100%;
}

.tab-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 12px 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
    color: #94a3b8;
    font-weight: 600;
    font-size: 0.85rem;
    text-align: center;
    min-height: 20px;
}

.tab-item i {
    font-size: 1.2rem;
    margin-bottom: 4px;
    transition: all 0.3s ease;
}

.tab-item.active {
    color: #f1f5f9;
    transform: translateY(-2px);
    background: rgba(15, 23, 42);
}

.tab-item.active i {
    transform: scale(1.1);
}

/* Room-specific active tab colors */
.tab-item.room-1.active {
    color: #10b981;
}

.tab-item.room-2.active {
    color: #38bdf8;
}

.tab-item.room-3.active {
    color: #f59e0b;
}

.tab-item.room-4.active {
    color: #8b5cf6;
}

/* Tab slider indicator */
.tab-slider {
    position: absolute;
    bottom: 4px;
    height: 2px;
    border-radius: 3px;
    transition: all 0.3s ease;
    z-index: 0;
}

.tab-slider.room-1 {
    background: #10b981;
}

.tab-slider.room-2 {
    background: #38bdf8;
}

.tab-slider.room-3 {
    background: #f59e0b;
}

.tab-slider.room-4 {
    background: #8b5cf6;
}

/* Tab content transitions */
.tab-content {
    display: none;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    padding-top: 6px;
    width: 100%;
}

.tab-content.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
}

/* Device Tabs - Facebook Style */
.device-tabs {
    display: flex;
    background: rgba(15, 23, 42);
    border-radius: 12px;
    padding: 8px;
    margin: 10px 0;
    box-shadow: 0 4px 12px rgba(15, 23, 42);
    position: relative;
    overflow: hidden;
    width: 100%;
    gap: 8px;
}

.device-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 04px 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
    color: #94a3b8;
    font-weight: 600;
    font-size: 0.85rem;
    text-align: center;
    border: none;
    background: transparent;
    min-height: 50px;
}

.device-tab:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #e2e8f0;
}

.device-tab.active-room-1,
.device-tab.active-room-2,
.device-tab.active-room-3,
.device-tab.active-room-4 {
    color: #f1f5f9;
    transform: translateY(-2px);
    background: rgba(15, 23, 42);
}

.device-tab.active-room-1 {
    color: #10b981;
}

.device-tab.active-room-2 {
    color: #38bdf8;
}

.device-tab.active-room-3 {
    color: #f59e0b;
}

.device-tab.active-room-4 {
    color: #8b5cf6;
}

/* Device tab slider */
.device-tab-slider {
    position: absolute;
    bottom: 4px;
    height: 2px;
    border-radius: 3px;
    transition: all 0.3s ease;
    z-index: 0;
}

.device-tab-slider.room-1 {
    background: #10b981;
}

.device-tab-slider.room-2 {
    background: #38bdf8;
}

.device-tab-slider.room-3 {
    background: #f59e0b;
}

.device-tab-slider.room-4 {
    background: #8b5cf6;
}

/* Settings Tabs - Facebook Style */
.settings-tabs {
    display: flex;
    background: rgba(15, 23, 42);
    border-radius: 12px;
    padding: 8px;
    margin: 10px 0;
    box-shadow: 0 4px 12px rgba(15, 23, 42);
    position: relative;
    overflow: hidden;
    width: 100%;
    gap: 8px;
}

.settings-tab {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
    color: #94a3b8;
    font-weight: 600;
    font-size: 0.85rem;
    text-align: center;
    border: none;
    background: transparent;
    min-height: 50px;
}

.settings-tab:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #e2e8f0;
}

.settings-tab.active {
    color: #f1f5f9;
    transform: translateY(-2px);
    background: rgba(56, 189, 248, 0.1);
}

.settings-tab.room-1-color.active {
    color: #10b981;
}

.settings-tab.room-2-color.active {
    color: #38bdf8;
}

.settings-tab.room-3-color.active {
    color: #f59e0b;
}

.settings-tab.room-4-color.active {
    color: #8b5cf6;
}

/* Settings tab slider */
.settings-tab-slider {
    position: absolute;
    bottom: 4px;
    height: 2px;
    border-radius: 3px;
    transition: all 0.3s ease;
    z-index: 0;
}

.settings-tab-slider.room-1 {
    background: #10b981;
}

.settings-tab-slider.room-2 {
    background: #38bdf8;
}

.settings-tab-slider.room-3 {
    background: #f59e0b;
}

.settings-tab-slider.room-4 {
    background: #8b5cf6;
}

/* Responsive adjustments */
@media (max-width: 480px) {
    .tab-item,
    .device-tab,
    .settings-tab {
        padding: 10px 6px;
        font-size: 0.8rem;
        min-height: 45px;
    }
    
    .tab-item i,
    .device-tab i,
    .settings-tab i {
        font-size: 1rem;
    }
}

/* Status styles */
.status { 
position: absolute;
  left: 50%;
  transform: translateX(-50%);
margin-top: 10px;
    display:inline-block; 
    padding:4px 10px; 
    border-radius:16px; 
    background:    #B22222;
    color:    #FFFAFA; 
    font-weight:600; 
    font-size:0.75rem; 
    margin-top:10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: background 0.3s;
    text-align: center;
}
.status.online { 
    background:#006400 !important; 
}
.status.unstable { 
    background: #f59e0b !important;
    color: #0f172a !important;
}
.status.connecting { 
    background: #4169E1 !important;
    color: #0f172a !important;
}
/* Version Info */
.version-info-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 98%;
    margin-right: 02px;  
    margin-top: 17px;
    font-size: 0.7rem;
}
.dashboard-version.room-1-version { color: #10b981; }
.dashboard-version.room-2-version { color: #38bdf8; }
.dashboard-version.room-3-version { color: #f59e0b; }
.dashboard-version.room-4-version { color: #8b5cf6; }
.firmware-version.room-1-firmware { color: #10b981; }
.firmware-version.room-2-firmware { color: #38bdf8; }
.firmware-version.room-3-firmware { color: #f59e0b; }
.firmware-version.room-4-firmware { color: #8b5cf6; }
.info-main { 
    display:grid; 
    grid-template-columns: 1fr 1fr; 
    gap:8px; 
    margin-top:17px; 
}
.panel { 
    background: rgba(30,41,59,0.9); 
    border-radius:10px; 
    padding:10px; 
    text-align:center; 
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
    border: 1px solid #334155;
}
.panel .label { 
    font-size:0.65rem; 
    color:#94a3b8; 
    margin-bottom:2px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.panel .value { 
    font-weight:700; 
    font-size:1rem; 
    color:#94a3b8; 
    overflow: hidden;
    text-overflow: ellipsis;
}
.relays { 
    display:flex; 
    justify-content:center; 
    gap:30px; 
    flex-wrap:wrap; 
    margin-bottom:30px; 
    padding: 15px 0;
}
.relay-btn { 
    width:65px; 
    height:65px; 
    border-radius:50%; 
    border:3px solid #475569; 
    display:flex; 
    flex-direction: column;
    justify-content:center; 
    align-items:center; 
    background:#1e293b; 
    color:#94a3b8; 
    font-weight:600; 
    font-size:0.85rem;
    cursor:pointer; 
    transition:0.3s; 
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
}
.relay-btn.on { 
    background:#10b981; 
    border-color:#34d399; 
    color:#042f2e; 
    box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
}
/* Device-specific relay colors */
.relay-btn.room-1.on { background: #34d399; border-color: #34d399; }
.relay-btn.room-2.on { background: #38bdf8; border-color: #7dd3fc; }
.relay-btn.room-3.on { background: #fbbf24; border-color: #fbbf24; }
.relay-btn.room-4.on { background: #8b5cf6; border-color: #a78bfa; }
/* Switch Styles */
.switch-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(30, 41, 59, 0.7);
    border-radius: 8px;
    border: 1px solid #334155;
}
.switch-label {
    color: #94a3b8;
    font-weight: 600;
    font-size: 0.9rem;
}
.switch {
    width: 50px;
    height: 24px;
    border-radius: 12px;
    background: #ef4444;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
}
.switch.on {
    background: #10b981;
}
.switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #fff;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
.switch.on::after {
    transform: translateX(26px);
}
/* Lock Switch Styles */
.lock-switch {
    width: 50px;
    height: 24px;
    border-radius: 12px;
    background: #10b981; /* Green when unlocked */
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
}
.lock-switch.locked {
    background: #ef4444; /* Red when locked */
}
.lock-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #fff;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.4);
}
.lock-switch.locked::after {
    transform: translateX(26px);
}
/* Current Device Indicator */
.current-device {
    text-align: center;
    margin: 8px 0;
    font-size: 0.9rem;
    font-weight: 600;
    color: #38bdf8;
    right: 50%;
    transform: translateX(-10%);
}
/* Device-specific theme colors */
.room-1-theme { color: #10b981; }
.room-2-theme { color: #38bdf8; }
.room-3-theme { color: #f59e0b; }
.room-4-theme { color: #8b5cf6; }
/* Basic styles for other components */
.automation-content-wrapper {
    max-width: 500px; 
    margin: 0 auto; 
}
/* NEW: Automation Schedule Styles */
.automation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding: 10px;
    background: rgba(30, 41, 59, 0.9);
    border-radius: 8px;
    border: 1px solid #334155;
}
.add-schedule-btn {
    background: #10b981;
    color: #042f2e;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}
.add-schedule-btn:hover {
    background: #059669;
}
.schedule-card {
    background: rgba(30, 41, 59, 0.9);
    border-radius: 10px;
    padding: 15px;
    margin-top: 07px;
    border: 1px solid #334155;
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
}
.schedule-card.enabled {
    border-left: 4px solid #10b981;
}
.schedule-card.disabled {
    border-left: 4px solid #ef4444;
    opacity: 0.7;
}
.schedule-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.schedule-name {
    font-weight: 700;
    color: #38bdf8;
    font-size: 1rem;
}
.schedule-actions {
    display: flex;
    gap: 6px;
}
.schedule-action-btn {
    background: none;
    border: none;
    color: #94a3b8;
    cursor: pointer;
    padding: 12px;
    border-radius: 4px;
    transition: color 0.2s;
}
.schedule-action-btn:hover {
    color: #e2e8f0;
}
.schedule-details {
    font-size: 0.85rem;
    color: #94a3b8;
    margin-bottom: 10px;
}
.schedule-trigger, .schedule-action {
    margin-bottom: 5px;
}
/* NEW: Next Execution Time Styles */
.next-execution {
    color: #10b981;
    font-weight: 600;
    background: rgba(16, 185, 129, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
    margin-top: 5px;
    display: inline-block;
}
/* Schedule Form Styles */
.schedule-form {
    background: rgba(30, 41, 59, 0.95);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    border: 2px solid #38bdf8;
}
.form-group {
    margin-bottom: 15px;
}
.form-label {
    display: block;
    margin-bottom: 5px;
    color: #94a3b8;
    font-weight: 600;
    font-size: 0.9rem;
}
.form-input, .form-select {
    width: 100%;
    padding: 8px;
    border: 1px solid #475569;
    border-radius: 6px;
    background: #1e293b;
    color: #f1f5f9;
    font-size: 0.9rem;
}
.form-input:focus, .form-select:focus {
    outline: none;
    border-color: #38bdf8;
}
.trigger-fields {
    background: rgba(55, 65, 81, 0.5);
    padding: 10px;
    border-radius: 6px;
    margin-top: 8px;
}
.days-selector {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 8px;
}
.day-checkbox {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.8rem;
}
.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 15px;
}
.save-btn {
    background: #10b981;
    color: #042f2e;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 600;
    cursor: pointer;
}
.cancel-btn {
    background: #64748b;
    color: #f1f5f9;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 600;
    cursor: pointer;
}

/* Weather Tab Styles - 2x2 Grid Layout */
.weather-content-wrapper {
    max-width: 400px; 
    margin: 0 auto;
    max-width: 400px; 
    margin-top: 15px;  
}
.weather-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
}
.weather-tile {
    background: rgba(30,41,59,0.9);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #334155;
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 120px;
}
.weather-tile .title {
    font-weight: 800;
    margin-bottom: 8px;
    color: #38bdf8;
    font-size: 1rem;
    text-align: center;
}
.weather-tile .value {
    font-weight: 700;
    font-size: 1.5rem;
    color:#94a3b8;
}
.weather-tile .unit {
    font-size: 0.9rem;
    color: #94a3b8;
    margin-left: 4px;
}
.weather-tile .icon {
    font-size: 2rem;
    margin-bottom: 8px;
    color: #38bdf8;
}
.weather-location {
    text-align: center;
    margin-bottom: 15px;
    color: #94a3b8;
    font-size: 0.9rem;
}
.weather-refresh-btn {
    background: #38bdf8;
    color: #0f172a;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 10px;
    transition: background 0.2s;
    width: 100%;
}
.weather-refresh-btn:hover {
    background: #0ea5e9;
}
.weather-refresh-btn:disabled {
    background: #64748b;
    cursor: not-allowed;
}
.weather-loading {
    text-align: center;
    color: #94a3b8;
    font-style: italic;
}
.weather-error {
    text-align: center;
    color: #fbbf24;
    font-size: 0.85rem;
    margin-top: 10px;
    padding: 8px;
    background: rgba(251, 191, 36, 0.1);
    border-radius: 6px;
    border: 1px solid rgba(251, 191, 36, 0.3);
}
.weather-source {
    text-align: center;
    font-size: 0.7rem;
    color: #64748b;
    margin-top: 5px;
} 

.log-viewer {
margin-top: 15px;
    height: 385px; 
    overflow-y: scroll;
    background: #1e293b;
    border-radius: 8px;
    padding: 8px;
    border: 1px solid #334155;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 0.8rem; 
    color: #cbd5e1;
}
/* Log entry styles */
.log-entry {
    border-bottom: 1px dotted #334155;
    padding: 3px 0;
}
.log-entry:last-child { border-bottom: none; }
.log-entry-time {
    color: #94a3b8;
    margin-right: 6px;
}
.log-entry-type-info { color: #38bdf8; }
.log-entry-type-warn { color: #fbbf24; }
.log-entry-type-error { color: #ef4444; }
.log-entry-type-relay { color: #10b981; }
.log-entry-type-device { color: #8b5cf6; }
.log-entry-type-rtdb { color: #f97316; }
.log-entry-type-weather { color: #06b6d4; }
.log-entry-type-automation { color: #f97316; }

/* NEW: Settings Modal Styles */
.settings-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 100;
    justify-content: center;
    align-items: center;
}
.settings-modal.show {
    display: flex;
}
.settings-content {
    background: #1e293b;
    border-radius: 12px;
    padding: 25px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    border: 1px solid #334155;
}
.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #334155;
}
.settings-header h3 {
    color: #38bdf8;
    margin: 0;
    font-size: 1.3rem;
}
.close-settings {
    background: none;
    border: none;
    color: #94a3b8;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
}
.close-settings:hover {
    color: #e2e8f0;
    background: rgba(255, 255, 255, 0.1);
}
.settings-panel {
    display: none;
}
.settings-panel.active {
    display: block;
}
.room-settings {
    margin-bottom: 20px;
}
.room-settings h4 {
    color: #38bdf8;
    margin-bottom: 15px;
    font-size: 1.1rem;
}
.settings-form-group {
    margin-bottom: 15px;
}
.settings-form-label {
    display: block;
    margin-bottom: 5px;
    color: #94a3b8;
    font-weight: 600;
    font-size: 0.9rem;
}
.settings-form-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #475569;
    border-radius: 6px;
    background: #0f172a;
    color: #f1f5f9;
    font-size: 0.9rem;
    box-sizing: border-box;
}
.settings-form-input:focus {
    outline: none;
    border-color: #38bdf8;
}
.relay-settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
.settings-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #334155;
}
.save-settings-btn {
    background: #10b981;
    color: #042f2e;
    border: none;
    border-radius: 6px;
    padding: 10px 20px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}
.save-settings-btn:hover {
    background: #059669;
}
.cancel-settings-btn {
    background: #64748b;
    color: #f1f5f9;
    border: none;
    border-radius: 6px;
    padding: 10px 20px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}
.cancel-settings-btn:hover {
    background: #475569;
}
/* Update for room-specific colors in settings */
.settings-tab.room-1-color.active { background: #10b981; }
.settings-tab.room-2-color.active { background: #38bdf8; }
.settings-tab.room-3-color.active { background: #f59e0b; }
.settings-tab.room-4-color.active { background: #8b5cf6; }
/* NEW: Error Message Modal Styles */
.error-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 100;
    justify-content: center;
    align-items: center;
}
.error-modal.show {
    display: flex;
}
.error-content {
    background: #1e293b;
    border-radius: 12px;
    padding: 25px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    border: 1px solid #334155;
    text-align: center;
}
.error-header {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #334155;
}
.error-header h3 {
    color: #ef4444;
    margin: 0;
    font-size: 1.3rem;
}
.error-icon {
    font-size: 2rem;
    color: #ef4444;
    margin-right: 10px;
}
.error-message {
    color: #e2e8f0;
    margin-bottom: 25px;
    font-size: 1rem;
    line-height: 1.5;
}
.error-actions {
    display: flex;
    justify-content: center;
}
.error-ok-btn {
    background: #ef4444;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 10px 20px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}
.error-ok-btn:hover {
    background: #b91c1c;
}
/* ADDED: Firmware Update Badge Styles */
.firmware-badge-container {
    position: absolute;
    top: 28px;
    right: 42px;
    z-index: 10;
}
.firmware-badge {
    position: relative;
    background: #191970;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    transition: transform 0.2s;
}
.firmware-badge:hover {
    transform: scale(1.1);
}
.firmware-badge.room-1-badge { background: #10b981; }
.firmware-badge.room-2-badge { background: #38bdf8; }
.firmware-badge.room-3-badge { background: #f59e0b; }
.firmware-badge.room-4-badge { background: #8b5cf6; }
/* ADDED: Firmware Update Modal Styles */
.firmware-update-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height:100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 100;
    justify-content: center;
    align-items: center;
}
.firmware-update-modal.show {
    display: flex;
}
.firmware-update-content {
    background: #1e293b;
    border-radius: 12px;
    padding: 05px;
    width: 90%;
    max-width: 400px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    border: 1px solid #334155;
}
.firmware-update-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 05px;
    padding-bottom: 05px;
    border-bottom: 1px solid #334155;
}
.firmware-update-header h3 {
    color: #38bdf8;
    margin: 0;
    font-size: 1.1rem;
}
.close-firmware-update {
    background: none;
    border: none;
    color: #94a3b8;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
}
.close-firmware-update:hover {
    color: #e2e8f0;
    background: rgba(255, 255, 255, 0.1);
}
.firmware-room-card {
    background: rgba(30, 41, 59, 0.9);
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 10px;
    border-left: 4px solid;
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
}
.firmware-room-card.room-1-card { border-left-color: #10b981; }
.firmware-room-card.room-2-card { border-left-color: #38bdf8; }
.firmware-room-card.room-3-card { border-left-color: #f59e0b; }
.firmware-room-card.room-4-card { border-left-color: #8b5cf6; }
.firmware-room-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}
.firmware-room-name {
    font-weight: 500;
    font-size: 1.1rem;
}
.firmware-room-name.room-1-name { color: #10b981; }
.firmware-room-name.room-2-name { color: #38bdf8; }
.firmware-room-name.room-3-name { color: #f59e0b; }
.firmware-room-name.room-4-name { color: #8b5cf6; }
.firmware-version-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 1px;
}
.firmware-version-item {
    text-align: center;
    padding: 08px;
    border-radius: 4px;
    background: rgba(15, 23, 42, 0.7);
}
.firmware-version-label {
    font-size: 0.8rem;
    color: #94a3b8;
    margin-bottom: 5px;
}
.firmware-version-value {
    font-weight: 700;
    font-size: 1rem;
}
.firmware-actions {
    display: flex;
    gap: 20px;
    justify-content: flex-end;
}
.firmware-action-btn {
    padding: 5px 10px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}
.firmware-update-btn {
    background: #10b981;
    color: #042f2e;
}
.firmware-update-btn:hover {
    background: #059669;
}
.firmware-skip-btn {
    background: #64748b;
    color: #f1f5f9;
}
.firmware-skip-btn:hover {
    background: #475569;
}
.firmware-no-updates {
    text-align: center;
    padding: 30px;
    color: #94a3b8;
}
</style>
</head>
<body>
<!-- Internet Connection Status Indicator -->
<div id="connectionStatus" style="display: none;"></div>

<div id="loginScreen">
  <div class="login-card">
    <h2>SMART HOME</h2>
    <input type="email" id="loginEmail" class="login-input" placeholder="Email">
    <input type="password" id="loginPassword" class="login-input" placeholder="Password">
    <button id="loginBtn" class="login-btn"><i class="fa fa-sign-in"></i> Sign In</button>
    <div id="loginError"></div>
  </div>
</div>

<div id="dashboardContainer" style="display: none;">
  <header>
    <!-- ADDED: Firmware Update Badge -->
    <div class="firmware-badge-container">
      <div class="firmware-badge" id="firmwareBadge" style="display: none;">
        <span id="firmwareBadgeCount">0</span>
      </div>
    </div>
    <!-- UPDATED: Profile menu moved to left corner -->
    <div class="profile-menu">
        <button class="profile-btn" id="profileBtn">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div class="dropdown-content" id="profileDropdown">
            <p>Logged in as:</p>
            <p id="userEmailDisplay">user@gmail.com</p>
            <div class="switch-container">
                <span class="switch-label">MUTE / UNMUTE</span>
                <div class="switch" id="beepSwitch"></div>
            </div>
            <div class="switch-container">
                <span class="switch-label">IR LOCK</span>
                <div class="lock-switch" id="irLockSwitch"></div>
            </div>
            <div class="switch-container">
                <span class="switch-label">BUTTON LOCK</span>
                <div class="lock-switch" id="buttonLockSwitch"></div>
            </div>
            <!-- NEW: Create User Button (only shown to admins) -->
            <button class="dropdown-btn settings-btn2" id="createUserBtn" style="display: none;">
              <i class="fas fa-user-plus"></i> Create New User</button>
            <!-- NEW: Edit Account Button -->
            <button class="dropdown-btn edit-account-btn" id="editAccountBtn">
              <i class="fas fa-user-edit"></i> Change Password</button>
            <!-- NEW: Settings Button -->
            <button class="dropdown-btn settings-btn" id="settingsBtn">
              <i class="fas fa-user-edit"></i> Room & Button Name</button>
            <button class="dropdown-btn restart-btn" id="restartBtn"><i class="fa-solid fa-power-off"></i> DEVICE RESTART</button>
            <button class="dropdown-btn logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </div>
    <!-- UPDATED: Branding header positioned in center -->
    <div class="branding-header">
      <img src="https://jahangirnrl.github.io/nrl/AAT_LOGO2.png"
           alt="Company Logo"
           class="branding-logo-img">
      <div class="branding-name">SMART HOME</div>
    </div>
    <!-- Empty div to maintain flexbox spacing -->
    <div></div>
  </header>
  
  <div class="header-center-content">
    <!-- Facebook-style Device Tabs -->
    <div class="device-tabs" id="facebookDeviceTabs">
      <div class="device-tab-slider" id="deviceTabSlider"></div>
      <button class="device-tab active-room-1" data-device="ROOM_1">Room-1</button>
      <button class="device-tab" data-device="ROOM_2">Room-2</button>
      <button class="device-tab" data-device="ROOM_3">Room-3</button>
      <button class="device-tab" data-device="ROOM_4">Room-4</button>
    </div>
    
    <div class="current-device room-1-theme" id="currentDeviceDisplay">Controlling: ROOM-1</div>
    
    <!-- Facebook-style Main Tabs -->
    <div class="tab-navigation" id="facebookTabs">
      <div class="tab-slider" id="tabSlider"></div>
      <div class="tab-item active" data-tab="dashboard">
        <i class="fas fa-power-off"></i>
        <span>Dashboard</span>
      </div>
      <div class="tab-item" data-tab="automation">
        <i class="fas fa-clock"></i>
        <span>Automation</span>
      </div>
      <div class="tab-item" data-tab="weather">
        <i class="fas fa-cloud-sun"></i>
        <span>Weather</span>
      </div>
      <div class="tab-item" data-tab="logs">
        <i class="fas fa-file-alt"></i>
        <span>Logs</span>
      </div>
    </div>
    
    <div class="version-info-container">
      <div class="dashboard-version room-1-version" id="versionInfo"></div>
      <div id="status" class="status">Offline</div>
      <div class="firmware-version room-1-firmware" id="firmwareInfo">Firmware: --</div>
    </div>
  </div>
  
  <div id="dashboard" class="tab-content active">
    <div class="info-main">
      <div class="panel"><div class="label">SSID</div><div id="ssid" class="value">--</div></div>
      <div class="panel"><div class="label">Uptime</div><div id="uptime" class="value">--</div></div>
      <div class="panel"><div class="label">IP</div><div id="ip" class="value">--</div></div>
      <div class="panel"><div class="label">SunRise</div><div id="sunrise" class="value">--:--</div></div>
      <div class="panel"><div class="label">MAC</div><div id="mac" class="value">--</div></div>
      <div class="panel"><div class="label">SunSet</div><div id="sunset" class="value">--:--</div></div>
      <!-- UPDATED: Combined Last Update panel - full width -->
      <div class="panel-full-width">
        <div class="label">Last Update</div>
        <div id="lastUpdateHuman" class="value">--:--</div>
      </div>
    </div>
    <div class="relays">
      <div id="r1" class="relay-btn">FAN</div>
      <div id="r2" class="relay-btn">LIGHT</div>
      <div id="r3" class="relay-btn">FAN-2</div>
      <div id="r4" class="relay-btn">DIM-L</div>
    </div>
  </div>
  
  <div id="automation" class="tab-content">
    <div class="automation-content-wrapper">
      <div class="automation-header">
        <h3 style="color: #38bdf8; margin: 0;">Automation Schedules</h3>
        <button class="add-schedule-btn" id="addScheduleBtn">
          <i class="fas fa-plus"></i> Add Schedule
        </button>
      </div>
      <div id="scheduleFormContainer" style="display: none;"></div>
      <div id="schedulesList"></div>
    </div>
  </div>
  
  <div id="weather" class="tab-content">
    <div class="weather-content-wrapper">
      <div class="weather-location" id="weatherLocationEl">Loading weather data...</div>
      <div class="weather-grid">
        <div class="weather-tile">
          <div class="icon"><i class="fas fa-thermometer-half"></i></div>
          <div class="title">Temperature</div>
          <div class="value"><span id="temperature">--</span><span class="unit">Â°C</span></div>
        </div>
        <div class="weather-tile">
          <div class="icon"><i class="fas fa-tint"></i></div>
          <div class="title">Humidity</div>
          <div class="value"><span id="humidity">--</span><span class="unit">%</span></div>
        </div>
        <div class="weather-tile">
          <div class="icon"><i class="fas fa-wind"></i></div>
          <div class="title">Wind Speed</div>
          <div class="value"><span id="windSpeed">--</span><span class="unit">km/h</span></div>
        </div>
        <div class="weather-tile">
          <div class="icon"><i class="fas fa-cloud-rain"></i></div>
          <div class="title">Rain Status</div>
          <div class="value"><span id="rainStatus">--</span></div>
        </div>
      </div>
      <button class="weather-refresh-btn" id="weatherRefreshBtn">
        <i class="fas fa-sync-alt"></i> Refresh Weather Data
      </button>
      <div id="weatherSource" class="weather-source"></div>
    </div>
  </div>
  
  <div id="logs" class="tab-content">
    <div class="log-viewer" id="logViewer">
      <div class="log-entry"><span class="log-entry-time">--:--:--</span><span class="log-entry-type-info">INFO:</span> Dashboard initialized. Please login.</div>
    </div>
  </div>
</div>

<!-- ADDED: Copyright Footer -->
<div class="copyright-footer">
  &copy; <span id="currentYear"></span> | Md. Jahangir Alam - 01911132254 | All rights reserved.
</div>

<!-- NEW: Settings Modal -->
<div class="settings-modal" id="settingsModal">
  <div class="settings-content">
    <div class="settings-header">
      <h3>Device Settings</h3>
      <button class="close-settings" id="closeSettingsBtn">&times;</button>
    </div>
    
    <!-- Facebook-style Settings Tabs -->
    <div class="settings-tabs" id="facebookSettingsTabs">
        <div class="settings-tab-slider" id="settingsTabSlider"></div>
        <button class="settings-tab room-1-color active" data-room="ROOM_1">Room 1</button>
        <button class="settings-tab room-2-color" data-room="ROOM_2">Room 2</button>
        <button class="settings-tab room-3-color" data-room="ROOM_3">Room 3</button>
        <button class="settings-tab room-4-color" data-room="ROOM_4">Room 4</button>
    </div>
    
    <div id="room1Settings" class="settings-panel active">
      <div class="room-settings">
        <h4>Room 1 Settings</h4>
        <div class="settings-form-group">
          <label class="settings-form-label">Room Display Name</label>
          <input type="text" id="room1Name" class="settings-form-input" placeholder="e.g., Living Room">
        </div>
        <div class="settings-form-group">
          <label class="settings-form-label">Relay Labels</label>
          <div class="relay-settings-grid">
            <input type="text" id="room1Relay1" class="settings-form-input" placeholder="Relay 1 Name">
            <input type="text" id="room1Relay2" class="settings-form-input" placeholder="Relay 2 Name">
            <input type="text" id="room1Relay3" class="settings-form-input" placeholder="Relay 3 Name">
            <input type="text" id="room1Relay4" class="settings-form-input" placeholder="Relay 4 Name">
          </div>
        </div>
      </div>
    </div>
    <div id="room2Settings" class="settings-panel">
      <div class="room-settings">
        <h4>Room 2 Settings</h4>
        <div class="settings-form-group">
          <label class="settings-form-label">Room Display Name</label>
          <input type="text" id="room2Name" class="settings-form-input" placeholder="e.g., Bedroom">
        </div>
        <div class="settings-form-group">
          <label class="settings-form-label">Relay Labels</label>
          <div class="relay-settings-grid">
            <input type="text" id="room2Relay1" class="settings-form-input" placeholder="Relay 1 Name">
            <input type="text" id="room2Relay2" class="settings-form-input" placeholder="Relay 2 Name">
            <input type="text" id="room2Relay3" class="settings-form-input" placeholder="Relay 3 Name">
            <input type="text" id="room2Relay4" class="settings-form-input" placeholder="Relay 4 Name">
          </div>
        </div>
      </div>
    </div>
    <div id="room3Settings" class="settings-panel">
      <div class="room-settings">
        <h4>Room 3 Settings</h4>
        <div class="settings-form-group">
          <label class="settings-form-label">Room Display Name</label>
          <input type="text" id="room3Name" class="settings-form-input" placeholder="e.g., Kitchen">
        </div>
        <div class="settings-form-group">
          <label class="settings-form-label">Relay Labels</label>
          <div class="relay-settings-grid">
            <input type="text" id="room3Relay1" class="settings-form-input" placeholder="Relay 1 Name">
            <input type="text" id="room3Relay2" class="settings-form-input" placeholder="Relay 2 Name">
            <input type="text" id="room3Relay3" class="settings-form-input" placeholder="Relay 3 Name">
            <input type="text" id="room3Relay4" class="settings-form-input" placeholder="Relay 4 Name">
          </div>
        </div>
      </div>
    </div>
    <div id="room4Settings" class="settings-panel">
      <div class="room-settings">
        <h4>Room 4 Settings</h4>
        <div class="settings-form-group">
          <label class="settings-form-label">Room Display Name</label>
          <input type="text" id="room4Name" class="settings-form-input" placeholder="e.g., Bathroom">
        </div>
        <div class="settings-form-group">
          <label class="settings-form-label">Relay Labels</label>
          <div class="relay-settings-grid">
            <input type="text" id="room4Relay1" class="settings-form-input" placeholder="Relay 1 Name">
            <input type="text" id="room4Relay2" class="settings-form-input" placeholder="Relay 2 Name">
            <input type="text" id="room4Relay3" class="settings-form-input" placeholder="Relay 3 Name">
            <input type="text" id="room4Relay4" class="settings-form-input" placeholder="Relay 4 Name">
          </div>
        </div>
      </div>
    </div>
    <div class="settings-actions">
      <button class="cancel-settings-btn" id="cancelSettingsBtn">Cancel</button>
      <button class="save-settings-btn" id="saveSettingsBtn">Save Settings</button>
    </div>
  </div>
</div>

<!-- NEW: Create User Modal -->
<div class="settings-modal" id="createUserModal">
  <div class="settings-content">
    <div class="settings-header">
      <h3>Create New User</h3>
      <button class="close-settings" id="closeCreateUserBtn">&times;</button>
    </div>
    <div class="settings-form-group">
      <label class="settings-form-label">Email Address</label>
      <input type="email" id="newUserEmail" class="settings-form-input" placeholder="Enter email address">
    </div>
    <div class="settings-form-group">
      <label class="settings-form-label">Password</label>
      <input type="password" id="newUserPassword" class="settings-form-input" placeholder="Enter password">
    </div>
    <div id="createUserError" style="color: #ef4444; margin-bottom: 15px; font-size: 0.9rem;"></div>
    <div class="settings-actions">
      <button class="cancel-settings-btn" id="cancelCreateUserBtn">Cancel</button>
      <button class="save-settings-btn" id="saveCreateUserBtn">Create User</button>
    </div>
  </div>
</div>

<!-- NEW: Edit Account Modal -->
<div class="settings-modal" id="editAccountModal">
  <div class="settings-content">
    <div class="settings-header">
      <h3>Change Account Password</h3>
      <button class="close-settings" id="closeEditAccountBtn">&times;</button>
    </div>
    <div class="settings-form-group">
      <label class="settings-form-label">Current Email</label>
      <input type="email" id="currentEmail" class="settings-form-input" readonly>
    </div>
    <div class="settings-form-group">
      <input type="email" style="display: none;" id="newEmail" class="settings-form-input" placeholder="Enter new email address">
    </div>
    <div class="settings-form-group">
      <label class="settings-form-label">Current Password</label>
      <input type="password" id="currentPassword" class="settings-form-input" placeholder="Enter current password">
    </div>
    <div class="settings-form-group">
      <label class="settings-form-label">New Password</label>
      <input type="password" id="newPassword" class="settings-form-input" placeholder="Enter new password">
    </div>
    <div class="settings-form-group">
      <label class="settings-form-label">Confirm New Password</label>
      <input type="password" id="confirmPassword" class="settings-form-input" placeholder="Confirm new password">
    </div>
    <div id="editAccountError" style="color: #ef4444; margin-bottom: 15px; font-size: 0.9rem;"></div>
    <div class="settings-actions">
      <button class="cancel-settings-btn" id="cancelEditAccountBtn">Cancel</button>
      <button class="save-settings-btn" id="saveEditAccountBtn">Save Changes</button>
    </div>
  </div>
</div>

<!-- NEW: Error Message Modal -->
<div class="error-modal" id="errorModal">
  <div class="error-content">
    <div class="error-header">
      <i class="fas fa-exclamation-triangle error-icon"></i>
      <h3>Error</h3>
    </div>
    <div class="error-message" id="errorMessage">An error has occurred.</div>
    <div class="error-actions">
      <button class="error-ok-btn" id="errorOkBtn">OK</button>
    </div>
  </div>
</div>

<!-- ADDED: Firmware Update Modal -->
<div class="firmware-update-modal" id="firmwareUpdateModal">
  <div class="firmware-update-content">
    <div class="firmware-update-header">
      <h3>Available Firmware..</h3>
      <button class="close-firmware-update" id="closeFirmwareUpdateBtn">&times;</button>
    </div>
    <div id="firmwareUpdateList">
      <!-- Room update cards will be inserted here -->
    </div>
    <div id="noFirmwareUpdates" class="firmware-no-updates" style="display: none;">
      <i class="fas fa-check-circle" style="font-size: 2rem; color: #10b981; margin-bottom: 10px;"></i>
      <p>All devices are up to date!</p>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
// ADDED: Set current year in copyright
document.getElementById('currentYear').textContent = new Date().getFullYear();        
// ADDED: Admin email configuration
const ADMIN_EMAILS = [
  'jahangir.nrl@gmail.com',
  'jahangir@example.com'
];
// ADDED: Function to check if current user is admin
function isAdminUser(user) {
  if (!user || !user.email) return false;
  return ADMIN_EMAILS.includes(user.email.toLowerCase());
}
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAei8j8RQXq_zspkohtH40g_gvHUfIx-Uw",
  authDomain: "home-control-df716.firebaseapp.com",
  databaseURL: "https://home-control-df716-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "home-control-df716",
  storageBucket: "home-control-df716.firebasestorage.app",
  messagingSenderId: "956714070689",
  appId: "1:956714070689:web:414179e22a04601349b6e0",
  measurementId: "G-LEHP8KM47D"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
// --- GLOBAL STATE & UI ELEMENTS ---
const SESSION_KEY = 'multiroom_session_active';
const DASHBOARD_VERSION = 'v3.7.0';
// Current device state
let currentDevice = 'ROOM_1';
const devices = ['ROOM_1', 'ROOM_2', 'ROOM_3', 'ROOM_4'];
// New Heartbeat Constants
const STABLE_MAX_MS = 15000;
const UNSTABLE_MAX_MS = 59000;
const HEARTBEAT_CHECK_INTERVAL_MS = 5000;
// UI Elements
const loginScreen = document.getElementById('loginScreen');
const dashboardContainer = document.getElementById('dashboardContainer');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');
const profileBtn = document.getElementById('profileBtn');
const profileDropdown = document.getElementById('profileDropdown');
const userEmailDisplay = document.getElementById('userEmailDisplay');
const logoutBtn = document.getElementById('logoutBtn');
const beepSwitch = document.getElementById('beepSwitch');
const irLockSwitch = document.getElementById('irLockSwitch');
const buttonLockSwitch = document.getElementById('buttonLockSwitch');
const restartBtn = document.getElementById('restartBtn');
const statusEl = document.getElementById('status');
const versionInfoEl = document.getElementById('versionInfo');
const firmwareInfoEl = document.getElementById('firmwareInfo');
const uptimeEl = document.getElementById('uptime');
const logViewer = document.getElementById('logViewer');
const relayBtns = [document.getElementById('r1'),document.getElementById('r2'),document.getElementById('r3'),document.getElementById('r4')];
const currentDeviceDisplay = document.getElementById('currentDeviceDisplay');
// NEW: Create User elements
const createUserBtn = document.getElementById('createUserBtn');
const createUserModal = document.getElementById('createUserModal');
const closeCreateUserBtn = document.getElementById('closeCreateUserBtn');
const cancelCreateUserBtn = document.getElementById('cancelCreateUserBtn');
const saveCreateUserBtn = document.getElementById('saveCreateUserBtn');
const newUserEmail = document.getElementById('newUserEmail');
const newUserPassword = document.getElementById('newUserPassword');
const createUserError = document.getElementById('createUserError');
// NEW: Edit Account elements
const editAccountBtn = document.getElementById('editAccountBtn');
const editAccountModal = document.getElementById('editAccountModal');
const closeEditAccountBtn = document.getElementById('closeEditAccountBtn');
const cancelEditAccountBtn = document.getElementById('cancelEditAccountBtn');
const saveEditAccountBtn = document.getElementById('saveEditAccountBtn');
const currentEmail = document.getElementById('currentEmail');
const newEmail = document.getElementById('newEmail');
const currentPassword = document.getElementById('currentPassword');
const newPassword = document.getElementById('newPassword');
const confirmPassword = document.getElementById('confirmPassword');
const editAccountError = document.getElementById('editAccountError');
// NEW: Error Modal elements
const errorModal = document.getElementById('errorModal');
const errorMessage = document.getElementById('errorMessage');
const errorOkBtn = document.getElementById('errorOkBtn');
// Automation elements
const addScheduleBtn = document.getElementById('addScheduleBtn');
const scheduleFormContainer = document.getElementById('scheduleFormContainer');
const schedulesList = document.getElementById('schedulesList');
// Weather elements
const temperatureEl = document.getElementById('temperature');
const humidityEl = document.getElementById('humidity');
const rainStatusEl = document.getElementById('rainStatus');
const windSpeedEl = document.getElementById('windSpeed');
const weatherLocationEl = document.getElementById('weatherLocation');
const weatherSourceEl = document.getElementById('weatherSource');
const weatherRefreshBtn = document.getElementById('weatherRefreshBtn');
// NEW: Settings elements
const settingsModal = document.getElementById('settingsModal');
const settingsBtn = document.getElementById('settingsBtn');
const closeSettingsBtn = document.getElementById('closeSettingsBtn');
const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const settingsPanels = document.querySelectorAll('.settings-panel');
// ADDED: Firmware Update elements
const firmwareBadge = document.getElementById('firmwareBadge');
const firmwareBadgeCount = document.getElementById('firmwareBadgeCount');
const firmwareUpdateModal = document.getElementById('firmwareUpdateModal');
const closeFirmwareUpdateBtn = document.getElementById('closeFirmwareUpdateBtn');
const firmwareUpdateList = document.getElementById('firmwareUpdateList');
const noFirmwareUpdates = document.getElementById('noFirmwareUpdates');

// --- INTERNET CONNECTION CHECKING ---
let isOnline = navigator.onLine;
let connectionCheckInterval;

// Function to check internet connection
function checkInternetConnection() {
    return new Promise((resolve) => {
        if (!navigator.onLine) {
            resolve(false);
            return;
        }
        fetch('https://www.google.com/favicon.ico?d=' + Date.now(), {
            method: 'HEAD',
            mode: 'no-cors',
            cache: 'no-cache'
        })
        .then(() => resolve(true))
        .catch(() => resolve(false));
    });
}

// Function to update connection status display
function updateConnectionStatus(connected) {
    isOnline = connected;
    
    let connectionStatusEl = document.getElementById('connectionStatus');
    if (!connectionStatusEl) {
        connectionStatusEl = document.createElement('div');
        connectionStatusEl.id = 'connectionStatus';
        document.body.appendChild(connectionStatusEl);
    }

    if (connected) {
        setTimeout(() => {
            connectionStatusEl.style.opacity = '0';
            setTimeout(() => {
                connectionStatusEl.style.display = 'none';
                connectionStatusEl.style.opacity = '1';
            }, 200);
        }, 1500);
    } else {
        connectionStatusEl.textContent = 'ð´ Check Internet..';
        connectionStatusEl.style.backgroundColor = '#DC143C';
        connectionStatusEl.style.color = '#334155';
        connectionStatusEl.style.display = 'block';
        connectionStatusEl.style.opacity = '3';
    }
}

// Function to handle session process when online
function startSessionProcess() {
    if (!isOnline) {
        console.log('No internet connection - cannot start session');
        addLogEntry('No internet connection - session process delayed', 'warn');
        return;
    }

    console.log('Internet available - starting session process...');
    addLogEntry('Internet connection established - starting session', 'info');
    
    if (localStorage.getItem(SESSION_KEY) === 'true') {
        showDashboard({ email: 'Checking session...' }); 
    } else {
        showLogin();
    }
    
    initializeFirmwareChecks();
    loadWeatherData();
}

// Monitor connection status
function startConnectionMonitoring() {
    checkInternetConnection().then(connected => {
        updateConnectionStatus(connected);
        if (connected) {
            startSessionProcess();
        } else {
            addLogEntry('No internet connection detected', 'warn');
        }
    });

    window.addEventListener('online', async () => {
        const connected = await checkInternetConnection();
        updateConnectionStatus(connected);
        if (connected) {
            console.log('Connection restored - resuming session');
            addLogEntry('Internet connection restored', 'info');
            startSessionProcess();
        }
    });

    window.addEventListener('offline', () => {
        updateConnectionStatus(false);
        console.log('Connection lost');
        addLogEntry('Internet connection lost', 'warn');
    });

    connectionCheckInterval = setInterval(async () => {
        const connected = await checkInternetConnection();
        updateConnectionStatus(connected);
    }, 30000);
}

// Stop connection monitoring
function stopConnectionMonitoring() {
    if (connectionCheckInterval) {
        clearInterval(connectionCheckInterval);
    }
}

// Modified initialization - check internet first
function initializeApp() {
    startConnectionMonitoring();
    addLogEntry('Smart Home initialized. Checking internet connection...', 'info');
}

// Device-specific state
const deviceStates = {};
devices.forEach(device => {
  deviceStates[device] = {
    online: false,
    lastHeartbeat: null,
    lastOnlineUpdate: null,
    connectionStability: 'unknown',
    relays: [false, false, false, false],
    firmware: '--',
    ip: '--',
    mac: '--',
    ssid: '--',
    uptime: '--',
    sunrise: '--:--',
    sunset: '--:--',
    lastUpdateHuman: '--:--',
    lastUpdate: '--:--'
  };
});
// Connection management
let clientConnected = false;
let allListeners = [];
// Weather Configuration
const WEATHER_UPDATE_INTERVAL = 10 * 60 * 1000;
let lastWeatherUpdate = 0;
// NEW: Room and Relay Names Management
let roomNames = {};
let relayNames = {};
// ADDED: Firmware Update State Management
let firmwareUpdates = {
  ROOM_1: { available: false, current: '', latest: '' },
  ROOM_2: { available: false, current: '', latest: '' },
  ROOM_3: { available: false, current: '', latest: '' },
  ROOM_4: { available: false, current: '', latest: '' }
};
// Initialize default names
function initializeDefaultNames() {
  devices.forEach(device => {
    roomNames[device] = device.replace('_', '-');
    relayNames[device] = ['FAN', 'LIGHT', 'FAN-2', 'DIM-L'];
  });
}
// Load room and relay names from Firebase
function loadRoomAndRelayNames() {
  devices.forEach(device => {
    db.ref(`HOME/${device}/R_B_NAME/roomName`).on('value', (snapshot) => {
      if (snapshot.exists()) {
        roomNames[device] = snapshot.val();
        updateUICustomNames();
      }
    });
    for (let i = 1; i <= 4; i++) {
      db.ref(`HOME/${device}/R_B_NAME/relay${i}`).on('value', (snapshot) => {
        if (snapshot.exists()) {
          if (!relayNames[device]) relayNames[device] = [];
          relayNames[device][i-1] = snapshot.val();
          updateUICustomNames();
        }
      });
    }
  });
}
// Save room and relay names to Firebase
function saveRoomAndRelayNamesToFirebase() {
  devices.forEach(device => {
    db.ref(`HOME/${device}/R_B_NAME/roomName`).set(roomNames[device]);
    for (let i = 1; i <= 4; i++) {
      db.ref(`HOME/${device}/R_B_NAME/relay${i}`).set(relayNames[device][i-1]);
    }
  });
}
// --- UTILITY FUNCTIONS ---
function formatTime12Hour(timestamp) {
  if (!timestamp) return '--:--:--';
  const d = new Date(timestamp);
  const formatter = new Intl.DateTimeFormat('en-US', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: true
  });
  return formatter.format(d);
}
// NEW: Function to convert 24-hour time to 12-hour format
function convertTo12Hour(time24) {
  if (!time24 || time24 === '--:--') return '--:--';
  const [hours, minutes] = time24.split(':');
  const hour = parseInt(hours);
  const ampm = hour >= 12 ? 'PM' : 'AM';
  const hour12 = hour % 12 || 12;
  return `${hour12}:${minutes} ${ampm}`;
}
function addLogEntry(message, type = 'info', source = 'client') {
  const time = formatTime12Hour(Date.now());
  const typeClass = `log-entry-type-${type.toLowerCase()}`;
  const sourceClass = source === 'device' ? 'log-entry-type-device' : source === 'rtdb' ? 'log-entry-type-rtdb' : source === 'weather' ? 'log-entry-type-weather' : source === 'automation' ? 'log-entry-type-automation' : '';
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.innerHTML = `<span class="log-entry-time">${time}</span><span class="${typeClass} ${sourceClass}">${type.toUpperCase()}:</span> ${message}`;
  logViewer.prepend(entry);
  while (logViewer.children.length > 50) {
    logViewer.removeChild(logViewer.lastChild);
  }
}
// NEW: Update UI with custom names
function updateUICustomNames() {
  const deviceTabs = document.querySelectorAll('#facebookDeviceTabs .device-tab');
  deviceTabs.forEach(tab => {
    const device = tab.dataset.device;
    if (roomNames[device]) {
      tab.textContent = roomNames[device];
    }
  });
  if (roomNames[currentDevice]) {
    currentDeviceDisplay.textContent = `Controlling: ${roomNames[currentDevice]}`;
  }
  if (relayNames[currentDevice]) {
    relayBtns.forEach((btn, index) => {
      btn.textContent = relayNames[currentDevice][index];
    });
  }
}
// NEW: Show error message in modal
function showErrorModal(message) {
  errorMessage.textContent = message;
  errorModal.classList.add('show');
}
// --- DEVICE MANAGEMENT FUNCTIONS ---
function getDevicePath(path) {
  return `HOME/${currentDevice}/${path}`;
}
function switchDevice(deviceId) {
  if (!devices.includes(deviceId)) return;
  console.log(`Switching to device: ${deviceId}`);
  cleanupListeners();
  currentDevice = deviceId;
  deviceStates[currentDevice].connectionStability = 'unknown'; 
  deviceStates[currentDevice].lastHeartbeat = null; 
  updateUICustomNames();
  
  const deviceTabs = document.querySelectorAll('#facebookDeviceTabs .device-tab');
  deviceTabs.forEach(tab => {
    tab.classList.remove('active-room-1', 'active-room-2', 'active-room-3', 'active-room-4');
    if (tab.dataset.device === deviceId) {
      const roomNum = deviceId.split('_')[1];
      tab.classList.add(`active-room-${roomNum}`);
    }
  });
  
  const roomNum = deviceId.split('_')[1];
  currentDeviceDisplay.className = `current-device room-${roomNum}-theme`;
  updateDeviceTheme();
  updateThemeColors();
  setupDeviceListeners();
  loadSchedules();
  
  const weatherTab = document.querySelector('#facebookTabs .tab-item[data-tab="weather"]');
  if (weatherTab && weatherTab.classList.contains('active')) {
      loadWeatherData();
  }
  
  addLogEntry(`Switched to ${roomNames[deviceId] || deviceId}`, 'info');
}
function updateDeviceTheme() {
  relayBtns.forEach(btn => {
    btn.className = btn.className.replace(/\broom-\d\b/g, '');
    const roomNum = currentDevice.split('_')[1];
    if (btn.classList.contains('on')) {
      btn.classList.add(`room-${roomNum}`);
    }
  });
}
function updateThemeColors() {
  const roomNum = currentDevice.split('_')[1];
  const tabItems = document.querySelectorAll('#facebookTabs .tab-item');
  tabItems.forEach(btn => {
    btn.classList.remove('room-1', 'room-2', 'room-3', 'room-4');
    if (btn.classList.contains('active')) {
      btn.classList.add(`room-${roomNum}`);
    }
  });
  versionInfoEl.className = `dashboard-version room-${roomNum}-version`;
  firmwareInfoEl.className = `firmware-version room-${roomNum}-firmware`;
}
function cleanupListeners() {
  allListeners.forEach(unsubscribe => {
    if (unsubscribe && typeof unsubscribe === 'function') {
      unsubscribe();
    }
  });
  allListeners = [];
}
function setupDeviceListeners() {
  console.log(`Setting up listeners for ${currentDevice}`);
  setupRelayListeners();
  setupDeviceInfoListeners();
  setupStatusListeners();
  setupSwitchListeners();
}
// --- ONLINE STATUS LOGIC (UPDATED) ---
function setupStatusListeners() {
    const onlinePath = getDevicePath('online');
    const deviceState = deviceStates[currentDevice];
    const onlineUnsubscribe = db.ref(onlinePath).on('value', (snap) => {
        const isOnline = snap.val() === true;
        if (isOnline === false) {
            deviceState.online = false;
            deviceState.connectionStability = 'offline';
        } else {
            deviceState.online = true;
            if (deviceState.lastHeartbeat === null) {
                deviceState.connectionStability = 'stable'; 
            }
        }
        updateStatusDisplay();
    });
    allListeners.push(() => db.ref(onlinePath).off('value', onlineUnsubscribe));
    setupHeartbeatPulseListener();
    startStabilityCheck();
}
function setupHeartbeatPulseListener() {
    let lastUptimeValue = '';
    const uptimeUnsubscribe = db.ref(getDevicePath('uptime')).on('value', snap => {
        const currentUptime = snap.val() || '';
        const deviceState = deviceStates[currentDevice];
        if (currentUptime !== lastUptimeValue && currentUptime !== '') {
            deviceState.lastHeartbeat = Date.now();
            deviceState.online = true;
        }
        lastUptimeValue = currentUptime;
        updateStatusDisplay(); 
    });
    allListeners.push(() => db.ref(getDevicePath('uptime')).off('value', uptimeUnsubscribe));
}
function startStabilityCheck() {
    const intervalId = setInterval(() => {
        const deviceState = deviceStates[currentDevice];
        const now = Date.now();
        const onlinePath = getDevicePath('online');
        if (!deviceState.online && deviceState.lastHeartbeat === null) {
            deviceState.connectionStability = 'connecting';
        } else if (deviceState.lastHeartbeat !== null) {
            const timeSinceLastHeartbeat = now - deviceState.lastHeartbeat;
            if (timeSinceLastHeartbeat <= STABLE_MAX_MS) {
                deviceState.connectionStability = 'stable';
                deviceState.online = true;
            } else if (timeSinceLastHeartbeat > STABLE_MAX_MS && timeSinceLastHeartbeat <= UNSTABLE_MAX_MS) {
                deviceState.connectionStability = 'unstable';
                deviceState.online = true;
            } else if (timeSinceLastHeartbeat > UNSTABLE_MAX_MS) {
                deviceState.connectionStability = 'offline';
                if (deviceState.online === true) {
                    deviceState.online = false;
                    db.ref(onlinePath).set(false).then(() => {
                        addLogEntry(`${currentDevice} heartbeat lost (>59s), RTDB /online set to false.`, 'rtdb');
                    }).catch(error => {
                        addLogEntry(`Failed to set /online to false: ${error.message}`, 'error');
                    });
                }
            }
        }
        updateStatusDisplay();
    }, HEARTBEAT_CHECK_INTERVAL_MS);
    allListeners.push(() => clearInterval(intervalId));
}
function updateStatusDisplay() {
    const deviceState = deviceStates[currentDevice];
    statusEl.classList.remove('online', 'unstable', 'connecting');
    statusEl.style.cssText = '';
    if (!clientConnected) {
        statusEl.textContent = "Client Disconnected";
        statusEl.style.backgroundColor = '#fbbf24';
        statusEl.style.color = '#0f172a';
    } else {
        switch(deviceState.connectionStability) {
            case 'stable':
                statusEl.textContent = "Online â";
                statusEl.classList.add('online');
                break;
            case 'unstable':
                statusEl.textContent = "Connection Unstable";
                statusEl.classList.add('unstable');
                break;
            case 'offline':
                statusEl.textContent = "Offline â";
                break;
            case 'connecting':
            case 'unknown':
            default:
                statusEl.textContent = "Connecting...";
                statusEl.classList.add('connecting');
        }
    }
}
/// --- RELAY CONTROL LOGIC ---
function toggleRelay(index){ 
  if (!clientConnected) {
    addLogEntry('Cannot toggle relay: Client disconnected from Firebase.', 'error');
    return;
  }
  const path = getDevicePath(`relay${index+1}`);
  console.log(`Toggling relay ${index+1} for ${currentDevice}`);
  db.ref(path).once('value').then(snap => {
    const newState = !snap.val();
    db.ref(path).set(newState);
    const relayName = relayBtns[index].textContent;
    const stateStr = newState ? 'ON' : 'OFF';
    addLogEntry(`${relayName} manually set to ${stateStr} for ${currentDevice}`, 'relay');
  }).catch(error => {
    addLogEntry(`Failed to read/write relay state: ${error.message}`, 'error');
    console.error('Relay toggle error:', error);
  });
}
function setRelayState(btn, on) { 
  btn.classList.toggle('on', on);
  btn.className = btn.className.replace(/\broom-\d\b/g, '');
  if (on) {
    const roomNum = currentDevice.split('_')[1];
    btn.classList.add(`room-${roomNum}`);
  }
}
function setupRelayListeners() {
  relayBtns.forEach((btn, i) => {
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    relayBtns[i] = newBtn;
  });
  relayBtns.forEach((btn, i) => {
    btn.addEventListener('click', () => toggleRelay(i));
  });
  for (let i = 0; i < 4; i++) {
    const relayPath = getDevicePath(`relay${i+1}`);
    console.log(`Listening to relay path: ${relayPath}`);
    const unsubscribe = db.ref(relayPath).on('value', snap => {
      const state = !!snap.val();
      console.log(`Relay ${i+1} state changed to: ${state} for ${currentDevice}`);
      deviceStates[currentDevice].relays[i] = state;
      setRelayState(relayBtns[i], state);
    }, error => {
      console.error(`Error listening to relay ${i+1}:`, error);
    });
    allListeners.push(() => db.ref(relayPath).off('value', unsubscribe));
  }
}
function setupDeviceInfoListeners() {
  const paths = [
    { path: 'device/ip', key: 'ip', element: 'ip' },
    { path: 'device/mac', key: 'mac', element: 'mac' },
    { path: 'device/ssid', key: 'ssid', element: 'ssid' },
    { path: 'device/firmwareVersion', key: 'firmware', element: null },
    { path: 'uptime', key: 'uptime', element: 'uptime' },
    { path: 'sunrise', key: 'sunrise', element: 'sunrise' },
    { path: 'sunset', key: 'sunset', element: 'sunset' },
    { path: 'lastUpdateHuman', key: 'lastUpdateHuman', element: 'lastUpdateHuman' },
    { path: 'lastUpdate', key: 'lastUpdate', element: null }
  ];
  paths.forEach(({ path, key, element }) => {
    const fullPath = getDevicePath(path);
    console.log(`Listening to device info: ${fullPath}`);
    const unsubscribe = db.ref(fullPath).on('value', (snap) => {
      const value = snap.val() || '--';
      deviceStates[currentDevice][key] = value;
      if (element && document.getElementById(element)) {
        document.getElementById(element).textContent = value;
      }
      if (key === 'firmware') {
        firmwareInfoEl.textContent = `Firmware: ${value}`;
      }
    }, error => {
      console.error(`Error listening to ${path}:`, error);
    });
    allListeners.push(() => db.ref(fullPath).off('value', unsubscribe));
  });
}
// --- SWITCH CONTROL FUNCTIONS ---
function setupSwitchListeners() {
  const beepUnsubscribe = db.ref(getDevicePath('settings/beepEnabled')).on('value', (snapshot) => {
    const beepState = snapshot.val();
    beepSwitch.classList.toggle('on', beepState === true);
  });
  allListeners.push(() => db.ref(getDevicePath('settings/beepEnabled')).off('value', beepUnsubscribe));
  const irLockUnsubscribe = db.ref(getDevicePath('settings/ir_lock')).on('value', (snapshot) => {
    const irLockState = snapshot.val();
    irLockSwitch.classList.toggle('locked', irLockState === true);
  });
  allListeners.push(() => db.ref(getDevicePath('settings/ir_lock')).off('value', irLockUnsubscribe));
  const buttonLockUnsubscribe = db.ref(getDevicePath('settings/button_lock')).on('value', (snapshot) => {
    const buttonLockState = snapshot.val();
    buttonLockSwitch.classList.toggle('locked', buttonLockState === true);
  });
  allListeners.push(() => db.ref(getDevicePath('settings/button_lock')).off('value', buttonLockUnsubscribe));
}
// BEEP Switch
beepSwitch.addEventListener('click', () => {
  if (!clientConnected) {
    addLogEntry('Cannot toggle BEEP: Client disconnected from Firebase.', 'error');
    return;
  }
  const newBeepState = !beepSwitch.classList.contains('on');
  db.ref(getDevicePath('settings/beepEnabled')).set(newBeepState)
    .then(() => {
      beepSwitch.classList.toggle('on', newBeepState);
      const statusText = newBeepState ? 'ENABLED' : 'DISABLED';
      addLogEntry(`BEEP ${statusText} for ${currentDevice}`, 'info');
      profileDropdown.classList.remove('show');
    })
    .catch(error => {
      addLogEntry(`Failed to set BEEP state: ${error.message}`, 'error');
    });
});
// IR Lock Switch
irLockSwitch.addEventListener('click', () => {
  if (!clientConnected) {
    addLogEntry('Cannot toggle IR Lock: Client disconnected from Firebase.', 'error');
    return;
  }
  const newIrLockState = !irLockSwitch.classList.contains('locked');
  db.ref(getDevicePath('settings/ir_lock')).set(newIrLockState)
    .then(() => {
      irLockSwitch.classList.toggle('locked', newIrLockState);
      const statusText = newIrLockState ? 'LOCKED' : 'UNLOCKED';
      addLogEntry(`IR ${statusText} for ${currentDevice}`, 'info');
      profileDropdown.classList.remove('show');
    })
    .catch(error => {
      addLogEntry(`Failed to set IR lock state: ${error.message}`, 'error');
    });
});
// Button Lock Switch
buttonLockSwitch.addEventListener('click', () => {
  if (!clientConnected) {
    addLogEntry('Cannot toggle Button Lock: Client disconnected from Firebase.', 'error');
    return;
  }
  const newButtonLockState = !buttonLockSwitch.classList.contains('locked');
  db.ref(getDevicePath('settings/button_lock')).set(newButtonLockState)
    .then(() => {
      buttonLockSwitch.classList.toggle('locked', newButtonLockState);
      const statusText = newButtonLockState ? 'LOCKED' : 'UNLOCKED';
      addLogEntry(`Physical Buttons ${statusText} for ${currentDevice}`, 'info');
      profileDropdown.classList.remove('show');
    })
    .catch(error => {
      addLogEntry(`Failed to set button lock state: ${error.message}`, 'error');
    });
});
// Restart Button
restartBtn.addEventListener('click', () => {
  if (!clientConnected) {
    addLogEntry('Cannot send RESTART command: Client disconnected from Firebase.', 'error');
    return;
  }
  if (confirm(`Are you sure you want to restart the ${currentDevice} device? This will temporarily disconnect the device.`)) {
    db.ref(getDevicePath('device/rest')).set(true)
      .then(() => {
        addLogEntry(`RESTART command sent to ${currentDevice}`, 'info');
        profileDropdown.classList.remove('show');
        setTimeout(() => {
          db.ref(getDevicePath('device/rest')).set(false)
            .catch(error => {
              addLogEntry(`Failed to reset restart flag: ${error.message}`, 'warn');
            });
        }, 13000);
      })
      .catch(error => {
        addLogEntry(`Failed to send RESTART command: ${error.message}`, 'error');
      });
  }
});
// --- WEATHER FUNCTIONS ---
async function fetchWeatherData(deviceId) {
    try {
        addLogEntry(`Fetching weather data for ${deviceId} from Firebase`, 'info', 'weather');
        const path = `HOME/${deviceId}/weather`;
        const snapshot = await db.ref(path).once('value');
        const weatherData = snapshot.val();
        if (!weatherData) {
            addLogEntry(`No weather data found for ${deviceId} at ${path}`, 'warn', 'weather');
            return {
                temperature: '--', humidity: '--', 
                location: `${roomNames[deviceId] || deviceId} | Weather`, 
                source: `${deviceId} | DHT-11`
            };
        }
        addLogEntry(`Weather data loaded for ${deviceId} from Firebase`, 'info', 'weather');
        return {
            temperature: weatherData.temperature || '--',
            humidity: weatherData.humidity || '--',
            rain: weatherData.rain || false,
            windSpeed: weatherData.windSpeed || '--',
            location: weatherData.location || `${roomNames[deviceId] || deviceId} | Weather`,
            source: weatherData.source || `${deviceId} | DHT-11`,
            pressure: weatherData.pressure || '--', 
            sunrise: weatherData.sunrise || '--:--', 
            sunset: weatherData.sunset || '--:--', 
            lastUpdateHuman: weatherData.lastUpdateHuman || '--:--', 
            lastUpdate: weatherData.lastUpdate || '--:--'
        };
    } catch (error) {
        addLogEntry(`Failed to fetch weather data for ${deviceId} from Firebase: ${error.message}`, 'error', 'weather');
        return null;
    }
}
function updateWeatherUI() {
    const deviceId = currentDevice;
    const weatherData = deviceStates[deviceId].weather;
    const roomName = roomNames[deviceId] || deviceId;
    const temperatureEl = document.getElementById('temperature');
    const humidityEl = document.getElementById('humidity');
    const windSpeedEl = document.getElementById('windSpeed');
    const weatherLocationEl = document.querySelector('.weather-location');
    const weatherSourceEl = document.getElementById('weatherSource');
    const weatherRefreshBtn = document.getElementById('weatherRefreshBtn');
    const existingError = document.querySelector('.weather-error');
    if (existingError) existingError.remove();
    temperatureEl.textContent = weatherData.temperature;
    humidityEl.textContent = weatherData.humidity;
    windSpeedEl.textContent = weatherData.windSpeed;
    weatherLocationEl.textContent = weatherData.location;
    weatherSourceEl.textContent = `Source: ${weatherData.source}`;
    weatherRefreshBtn.disabled = false;
    weatherRefreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Weather Data';
    addLogEntry(`Weather UI updated for ${roomName}`, 'info', 'weather');
}
async function loadWeatherData() {
    const weatherTab = document.querySelector('#facebookTabs .tab-item[data-tab="weather"]');
    if (!weatherTab || !weatherTab.classList.contains('active')) {
        return;
    }
    const deviceId = currentDevice; 
    const roomName = roomNames[deviceId] || deviceId;
    const weatherRefreshBtn = document.getElementById('weatherRefreshBtn');
    const weatherLocationEl = document.querySelector('.weather-location');
    const temperatureEl = document.getElementById('temperature');
    const humidityEl = document.getElementById('humidity');
    const weatherSourceEl = document.getElementById('weatherSource');
    weatherRefreshBtn.disabled = true;
    weatherRefreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    weatherLocationEl.textContent = 'Loading weather data...';
    temperatureEl.textContent = '--'; 
    humidityEl.textContent = '--'; 
    weatherSourceEl.textContent = '';
    const newWeatherData = await fetchWeatherData(deviceId); 
    if (newWeatherData) {
        deviceStates[deviceId].weather = { 
            ...deviceStates[deviceId].weather,
            ...newWeatherData 
        };
    } else {
        const errorEl = document.createElement('div');
        errorEl.className = 'weather-error';
        errorEl.innerHTML = `Could not load weather data for ${roomName}.<br>Please check Firebase path: <b>HOME/${deviceId}/weather</b>.`;
        document.querySelector('.weather-content-wrapper').appendChild(errorEl);
        deviceStates[deviceId].weather = { 
            temperature: '--', humidity: '--', 
            location: `No data for ${roomName}`, source: 'Failed to Load', 
            pressure: '--', sunrise: '--:--', sunset: '--:--', 
            lastUpdateHuman: '--:--', lastUpdate: '--:--'
        };
    }
    updateWeatherUI();
}
document.getElementById('weatherRefreshBtn').addEventListener('click', () => {
  loadWeatherData1(); loadWeatherData();
});    
// --- NEW: SETTINGS FUNCTIONS ---
function openSettingsModal() {
  const settingsTabs = document.querySelectorAll('#facebookSettingsTabs .settings-tab');
  settingsTabs.forEach(t => t.classList.remove('active'));
  settingsPanels.forEach(p => p.classList.remove('active'));
  document.querySelector('#facebookSettingsTabs .settings-tab[data-room="ROOM_1"]').classList.add('active');
  document.getElementById('room1Settings').classList.add('active');
  devices.forEach(device => {
    const roomNum = device.split('_')[1];
    document.getElementById(`room${roomNum}Name`).value = roomNames[device] || '';
    for (let i = 1; i <= 4; i++) {
      document.getElementById(`room${roomNum}Relay${i}`).value = relayNames[device] ? relayNames[device][i-1] : '';
    }
  });
  settingsModal.classList.add('show');
  profileDropdown.classList.remove('show');
  updateSettingsTabSlider();
}
function closeSettingsModal() {
  settingsModal.classList.remove('show');
}
function saveSettings() {
  const newRoomNames = {...roomNames};
  const newRelayNames = {...relayNames};
  devices.forEach(device => {
    const roomNum = device.split('_')[1];
    const roomNameInput = document.getElementById(`room${roomNum}Name`);
    newRoomNames[device] = roomNameInput.value.trim() || device.replace('_', '-');
    if (!newRelayNames[device]) newRelayNames[device] = [];
    for (let i = 1; i <= 4; i++) {
      const relayInput = document.getElementById(`room${roomNum}Relay${i}`);
      newRelayNames[device][i-1] = relayInput.value.trim() || `Relay ${i}`;
    }
  });
  roomNames = newRoomNames;
  relayNames = newRelayNames;
  saveRoomAndRelayNamesToFirebase();
  updateUICustomNames();
  closeSettingsModal();
  addLogEntry('Room and relay names updated', 'info');
}
// Event listeners for settings
settingsBtn.addEventListener('click', openSettingsModal);
closeSettingsBtn.addEventListener('click', closeSettingsModal);
cancelSettingsBtn.addEventListener('click', closeSettingsModal);
saveSettingsBtn.addEventListener('click', saveSettings);
// Close modal when clicking outside
window.addEventListener('click', (event) => {
  if (event.target === settingsModal) {
    closeSettingsModal(); 
  }
});
// --- NEW: CREATE USER FUNCTIONS ---
function openCreateUserModal() {
  newUserEmail.value = '';
  newUserPassword.value = '';
  createUserError.textContent = '';
  createUserModal.classList.add('show');
  profileDropdown.classList.remove('show');
}
function closeCreateUserModal() {
  createUserModal.classList.remove('show');
}
async function createNewUser() {
  const email = newUserEmail.value;
  const password = newUserPassword.value;
  createUserError.textContent = '';
  if (!email || !password) {
    createUserError.textContent = 'Please enter both email and password.';
    return;
  }
  if (password.length < 6) {
    createUserError.textContent = 'Password should be at least 6 characters.';
    return;
  }
  try {
    saveCreateUserBtn.disabled = true;
    saveCreateUserBtn.textContent = 'Creating...';
    await auth.createUserWithEmailAndPassword(email, password);
    addLogEntry(`Admin created new user account: ${email}`, 'info');
    closeCreateUserModal();
    alert(`User ${email} created successfully!`);
  } catch (error) {
    let errorMessage = error.message.replace('Firebase: ', '');
    if (error.code === 'auth/email-already-in-use') {
      errorMessage = 'This email address is already registered.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'Please enter a valid email address.';
    } else if (error.code === 'auth/operation-not-allowed') {
      errorMessage = 'Account creation is currently disabled.';
    } else if (error.code === 'auth/weak-password') {
      errorMessage = 'Password should be at least 6 characters.';
    }
    createUserError.textContent = errorMessage;
    addLogEntry(`Failed to create user: ${error.message}`, 'error');
  } finally {
    saveCreateUserBtn.disabled = false;
    saveCreateUserBtn.textContent = 'Create User';
  }
}
// NEW: Create User event listeners
createUserBtn.addEventListener('click', openCreateUserModal);
closeCreateUserBtn.addEventListener('click', closeCreateUserModal);
cancelCreateUserBtn.addEventListener('click', closeCreateUserModal);
saveCreateUserBtn.addEventListener('click', createNewUser);
// Close create user modal when clicking outside
window.addEventListener('click', (event) => {
  if (event.target === createUserModal) {
    closeCreateUserModal();
  }
});
// --- NEW: EDIT ACCOUNT FUNCTIONS ---
function openEditAccountModal() {
  const user = auth.currentUser;
  if (!user) return;
  currentEmail.value = user.email;
  newEmail.value = '';
  currentPassword.value = '';
  newPassword.value = '';
  confirmPassword.value = '';
  editAccountError.textContent = '';
  editAccountModal.classList.add('show');
  profileDropdown.classList.remove('show');
}
function closeEditAccountModal() {
  editAccountModal.classList.remove('show');
}
// NEW: Edit Account event listeners
editAccountBtn.addEventListener('click', openEditAccountModal);
closeEditAccountBtn.addEventListener('click', closeEditAccountModal);
cancelEditAccountBtn.addEventListener('click', closeEditAccountModal);
saveEditAccountBtn.addEventListener('click', async () => {
  const user = auth.currentUser;
  const currentPass = currentPassword.value.trim();
  const newPass = newPassword.value.trim();
  const confirmPass = confirmPassword.value.trim();
  editAccountError.textContent = '';
  if (!currentPass || !newPass || !confirmPass) {
    editAccountError.textContent = 'Please fill all password fields.';
    return;
  }
  if (newPass !== confirmPass) {
    editAccountError.textContent = 'New passwords do not match.';
    return;
  }
  try {
    const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPass);
    await user.reauthenticateWithCredential(credential);
    await user.updatePassword(newPass);
    showErrorModal('Password updated successfully!');
    editAccountModal.classList.remove('show');
  } catch (error) {
    console.error('Edit Account Error:', error);
    if (error.code === 'auth/wrong-password' || error.message.includes('INVALID_LOGIN_CREDENTIALS')) {
      editAccountError.textContent = 'â Current password is incorrect.';
    } else if (error.code === 'auth/weak-password') {
      editAccountError.textContent = 'Password must be at least 6 characters.';
    } else {
      editAccountError.textContent = 'Something went wrong. Please try again.';
    }
  }
});
// Close edit account modal when clicking outside
window.addEventListener('click', (event) => {
  if (event.target === editAccountModal) {
    closeEditAccountModal();
  }
});
// NEW: Error Modal event listeners
errorOkBtn.addEventListener('click', () => {
  errorModal.classList.remove('show');
});
// Close error modal when clicking outside
window.addEventListener('click', (event) => {
  if (event.target === errorModal) {
    errorModal.classList.remove('show');
  }
});
// --- AUTOMATION SCHEDULE FUNCTIONS ---
function showScheduleForm(scheduleData = null) {
    const isEdit = scheduleData !== null;
    const scheduleId = scheduleData?.id || getNextAvailableScheduleId();
    let nextExecutionDisplay = 'Will be calculated after save';
    if (isEdit && (scheduleData.type === 'sunrise' || scheduleData.type === 'sunset')) {
        nextExecutionDisplay = calculateNextExecutionTime(scheduleData);
    }
    const formHTML = `
        <div class="schedule-form">
            <h3 style="color: #38bdf8; margin-bottom: 15px;">${isEdit ? 'Edit Schedule' : 'Add New Schedule'}</h3>
            <div class="form-group">
                <label class="form-label">Schedule Name</label>
                <input type="text" id="scheduleName" class="form-input" value="${isEdit ? scheduleData.name : ''}" placeholder="Enter schedule name">
            </div>
            <div class="form-group">
                <label class="form-label">Schedule Type</label>
                <select id="scheduleType" class="form-select">
                    <option value="daily" ${isEdit && scheduleData.type === 'daily' ? 'selected' : ''}>Daily Time</option>
                    <option value="weekly" ${isEdit && scheduleData.type === 'weekly' ? 'selected' : ''}>Weekly Time</option>
                    <option value="sunrise" ${isEdit && scheduleData.type === 'sunrise' ? 'selected' : ''}>Sunrise with Offset</option>
                    <option value="sunset" ${isEdit && scheduleData.type === 'sunset' ? 'selected' : ''}>Sunset with Offset</option>
                    <option value="temperature" ${isEdit && scheduleData.type === 'temperature' ? 'selected' : ''}>Temperature</option>
                    <option value="timer" ${isEdit && scheduleData.type === 'timer' ? 'selected' : ''}>Timer</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Relay</label>
                <select id="scheduleRelay" class="form-select">
                    <option value="1" ${isEdit && scheduleData.relay === 1 ? 'selected' : ''}>Relay 1 (FAN)</option>
                    <option value="2" ${isEdit && scheduleData.relay === 2 ? 'selected' : ''}>Relay 2 (LIGHT)</option>
                    <option value="3" ${isEdit && scheduleData.relay === 3 ? 'selected' : ''}>Relay 3 (FAN-2)</option>
                    <option value="4" ${isEdit && scheduleData.relay === 4 ? 'selected' : ''}>Relay 4 (DIM-L)</option>
                </select>
            </div>
            <div id="triggerFields" class="trigger-fields">
                ${renderTriggerFields(scheduleData)}
            </div>
            <div class="form-group">
                <label class="form-label">Action</label>
                <select id="actionSelect" class="form-select">
                    <option value="true" ${isEdit && scheduleData.action === true ? 'selected' : ''}>Turn ON</option>
                    <option value="false" ${isEdit && scheduleData.action === false ? 'selected' : ''}>Turn OFF</option>
                </select>
            </div>
            ${(scheduleData?.type === 'sunrise' || scheduleData?.type === 'sunset') ? `
            <div class="form-group">
                <label class="form-label">Next Execution</label>
                <div class="next-execution">${nextExecutionDisplay}</div>
            </div>
            ` : ''}
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="scheduleEnabled" ${isEdit && scheduleData.enabled !== false ? 'checked' : ''}>
                    Enable Schedule
                </label>
            </div>
            <div class="form-actions">
                <button class="cancel-btn" id="cancelScheduleBtn">Cancel</button>
                <button class="save-btn" id="saveScheduleBtn">Save Schedule</button>
            </div>
        </div>
    `;
    scheduleFormContainer.innerHTML = formHTML;
    scheduleFormContainer.style.display = 'block';
    document.getElementById('cancelScheduleBtn').addEventListener('click', hideScheduleForm);
    document.getElementById('saveScheduleBtn').addEventListener('click', () => saveSchedule(scheduleId));
    document.getElementById('scheduleType').addEventListener('change', updateTriggerFields);
    scheduleFormContainer.scrollIntoView({ behavior: 'smooth' });
}
function getNextAvailableScheduleId() {
    for (let i = 1; i <= 50; i++) {
        if (!document.querySelector(`[data-schedule-id="${i}"]`)) {
            return i;
        }
    }
    return 1;
}
function renderTriggerFields(scheduleData) {
    const scheduleType = scheduleData?.type || 'daily';
    switch(scheduleType) {
        case 'daily':
            return `
                <div class="form-group">
                    <label class="form-label">ON Time</label>
                    <input type="time" id="onTime" class="form-input" value="${scheduleData?.onTime || '07:00'}">
                </div>
                <div class="form-group">
                    <label class="form-label">OFF Time</label>
                    <input type="time" id="offTime" class="form-input" value="${scheduleData?.offTime || '18:00'}">
                </div>
            `;
        case 'weekly':
            return `
                <div class="form-group">
                    <label class="form-label">ON Time</label>
                    <input type="time" id="onTime" class="form-input" value="${scheduleData?.onTime || '07:00'}">
                </div>
                <div class="form-group">
                    <label class="form-label">OFF Time</label>
                    <input type="time" id="offTime" class="form-input" value="${scheduleData?.offTime || '18:00'}">
                </div>
                <div class="form-group">
                    <label class="form-label">Days (0=Sun, 1=Mon, ..., 6=Sat)</label>
                    <input type="text" id="days" class="form-input" value="${scheduleData?.days || '1,2,3,4,5'}" placeholder="e.g., 1,2,3,4,5">
                    <small style="color: #94a3b8;">Comma-separated day numbers (0-6)</small>
                </div>
            `;
        case 'sunrise':
        case 'sunset':
            const offset = scheduleData?.offset || 0;
            return `
                <div class="form-group">
                    <label class="form-label">Offset (minutes)</label>
                    <input type="number" id="sunOffset" class="form-input" value="${offset}" min="-120" max="120" step="1">
                    <small style="color: #94a3b8;">Positive for after ${scheduleType}, negative for before ${scheduleType}</small>
                </div>
            `;
        case 'temperature':
            const condition = scheduleData?.condition || '>';
            const tempValue = scheduleData?.value || 25;
            return `
                <div class="form-group">
                    <label class="form-label">Condition</label>
                    <select id="tempCondition" class="form-select">
                        <option value=">" ${condition === '>' ? 'selected' : ''}>Temperature Above</option>
                        <option value="<" ${condition === '<' ? 'selected' : ''}>Temperature Below</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Temperature Value (Â°C)</label>
                    <input type="number" id="tempValue" class="form-input" value="${tempValue}" min="-10" max="50" step="0.5" placeholder="Enter temperature">
                </div>
            `;
        case 'timer':
            return `
                <div class="form-group">
                    <label class="form-label">Duration (minutes)</label>
                    <input type="number" id="duration" class="form-input" value="${scheduleData?.duration || 30}" min="1" max="1440">
                </div>
            `;
        default:
            return '';
    }
}
function updateTriggerFields() {
    const scheduleType = document.getElementById('scheduleType').value;
    const triggerFields = document.getElementById('triggerFields');
    const tempScheduleData = { type: scheduleType };
    triggerFields.innerHTML = renderTriggerFields(tempScheduleData);
}
function hideScheduleForm() {
    scheduleFormContainer.style.display = 'none';
    scheduleFormContainer.innerHTML = '';
}
function saveSchedule(scheduleId) {
    if (!clientConnected) {
        addLogEntry('Cannot save schedule: Client disconnected from Firebase.', 'error');
        return;
    }
    const scheduleType = document.getElementById('scheduleType').value;
    const name = document.getElementById('scheduleName').value;
    const relay = parseInt(document.getElementById('scheduleRelay').value);
    const action = document.getElementById('actionSelect').value === 'true';
    const enabled = document.getElementById('scheduleEnabled').checked;
    if (!name.trim()) {
        alert('Please enter a schedule name');
        return;
    }
    if (relay < 1 || relay > 4) {
        alert('Please select a valid relay (1-4)');
        return;
    }
    const scheduleData = {
        name: name,
        enabled: enabled,
        type: scheduleType,
        relay: relay,
        action: action
    };
    if (scheduleType === 'daily' || scheduleType === 'weekly') {
        const onTime = document.getElementById('onTime').value;
        const offTime = document.getElementById('offTime').value;
        if (!onTime || !offTime) {
            alert('Please enter both ON and OFF times');
            return;
        }
        scheduleData.onTime = onTime;
        scheduleData.offTime = offTime;
        if (scheduleType === 'weekly') {
            const days = document.getElementById('days').value;
            if (!days.trim()) {
                alert('Please enter days for weekly schedule');
                return;
            }
            scheduleData.days = days;
        }
    } else if (scheduleType === 'sunrise' || scheduleType === 'sunset') {
        const offset = parseInt(document.getElementById('sunOffset').value) || 0;
        scheduleData.offset = offset;
        scheduleData.nextExecution = calculateNextExecutionTime(scheduleData);
    } else if (scheduleType === 'temperature') {
        const condition = document.getElementById('tempCondition').value;
        const value = parseFloat(document.getElementById('tempValue').value);
        if (isNaN(value)) {
            alert('Please enter a valid temperature');
            return;
        }
        scheduleData.condition = condition;
        scheduleData.value = value;
    } else if (scheduleType === 'timer') {
        const duration = parseInt(document.getElementById('duration').value);
        if (isNaN(duration) || duration < 1) {
            alert('Please enter a valid duration');
            return;
        }
        scheduleData.duration = duration;
    }
    const path = getDevicePath(`automation/schedule${scheduleId}`);
    db.ref(path).set(scheduleData)
        .then(() => {
            addLogEntry(`Schedule "${name}" ${scheduleData.enabled ? 'created/enabled' : 'created/disabled'} for ${currentDevice}`, 'automation', 'automation');
            hideScheduleForm();
            loadSchedules();
        })
        .catch(error => {
            addLogEntry(`Failed to save schedule: ${error.message}`, 'error');
            alert('Failed to save schedule: ' + error.message);
        });
}
function calculateNextExecutionTime(scheduleData) {
    const sunriseTime = deviceStates[currentDevice].sunrise;
    const sunsetTime = deviceStates[currentDevice].sunset;
    if ((!sunriseTime || sunriseTime === '--:--') && (!sunsetTime || sunsetTime === '--:--')) {
        return 'Waiting for sunrise/sunset data';
    }
    if (scheduleData.type === 'sunrise') {
        if (!sunriseTime || sunriseTime === '--:--') {
            return 'Waiting for sunrise data';
        }
        const [sunriseHours, sunriseMinutes] = sunriseTime.split(':');
        const sunriseDate = new Date();
        sunriseDate.setHours(parseInt(sunriseHours), parseInt(sunriseMinutes) + scheduleData.offset, 0, 0);
        return `Today at ${convertTo12Hour(sunriseTime)} ${scheduleData.offset >= 0 ? '+ ' : ''}${scheduleData.offset} min ( ${convertTo12Hour(formatTime(sunriseDate))} )`;
    } else if (scheduleData.type === 'sunset') {
        if (!sunsetTime || sunsetTime === '--:--') {
            return 'Waiting for sunset data';
        }
        const [sunsetHours, sunsetMinutes] = sunsetTime.split(':');
        const sunsetDate = new Date();
        sunsetDate.setHours(parseInt(sunsetHours), parseInt(sunsetMinutes) + scheduleData.offset, 0, 0);
        return `Today at ${convertTo12Hour(sunsetTime)} ${scheduleData.offset >= 0 ? '+' : ''}${scheduleData.offset}min (${convertTo12Hour(formatTime(sunsetDate))})`;
    }
    return 'Will be calculated';
}
// Helper function to format time as HH:MM
function formatTime(date) {
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
}
function deleteSchedule(scheduleId) {
    if (!clientConnected) {
        addLogEntry('Cannot delete schedule: Client disconnected from Firebase.', 'error');
        return;
    }
    if (confirm('Are you sure you want to delete this schedule?')) {
        db.ref(getDevicePath(`automation/schedule${scheduleId}`)).remove()
            .then(() => {
                addLogEntry(`Schedule deleted from ${currentDevice}`, 'automation', 'automation');
                loadSchedules();
            })
            .catch(error => {
                addLogEntry(`Failed to delete schedule: ${error.message}`, 'error');
            });
    }
}
function toggleSchedule(scheduleId, currentState) {
    if (!clientConnected) {
        addLogEntry('Cannot toggle schedule: Client disconnected from Firebase.', 'error');
        return;
    }
    const newState = !currentState;
    db.ref(getDevicePath(`automation/schedule${scheduleId}/enabled`)).set(newState)
        .then(() => {
            const statusText = newState ? 'ENABLED' : 'DISABLED';
            addLogEntry(`Schedule ${statusText} for ${currentDevice}`, 'automation', 'automation');
            loadSchedules();
        })
        .catch(error => {
            addLogEntry(`Failed to toggle schedule: ${error.message}`, 'error');
        });
}
function loadSchedules() {
    const schedulePromises = [];
    for (let i = 1; i <= 50; i++) {
        schedulePromises.push(
            db.ref(getDevicePath(`automation/schedule${i}`)).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        return { id: i, ...snapshot.val() };
                    }
                    return null;
                })
        );
    }
    Promise.all(schedulePromises)
        .then((schedules) => {
            const validSchedules = schedules.filter(schedule => schedule !== null);
            displaySchedules(validSchedules);
        })
        .catch(error => {
            addLogEntry(`Failed to load schedules: ${error.message}`, 'error');
        });
}
function displaySchedules(schedules) {
    schedulesList.innerHTML = '';
    if (schedules.length === 0) {
        schedulesList.innerHTML = `
            <div class="schedule-card">
                <div style="text-align: center; color: #94a3b8; padding: 20px;">
                    No schedules found for ${currentDevice}. Click "Add Schedule" to create your first automation.
                </div>
            </div>
        `;
        return;
    }
    schedules.sort((a, b) => a.id - b.id);
    schedules.forEach(schedule => {
        const card = document.createElement('div');
        card.className = `schedule-card ${schedule.enabled ? 'enabled' : 'disabled'}`;
        card.setAttribute('data-schedule-id', schedule.id);
        let triggerText = '';
        switch(schedule.type) {
            case 'daily':
                triggerText = `Daily: ON at ${convertTo12Hour(schedule.onTime)}, OFF at ${convertTo12Hour(schedule.offTime)}`;
                break;
            case 'weekly':
                triggerText = `Weekly: ON at ${convertTo12Hour(schedule.onTime)}, OFF at ${convertTo12Hour(schedule.offTime)} on days ${schedule.days}`;
                break;
            case 'sunrise':
                triggerText = `Sunrise ${schedule.offset >= 0 ? '+' : ''}${schedule.offset} minutes: ${schedule.action ? 'ON' : 'OFF'}`;
                break;
            case 'sunset':
                triggerText = `Sunset ${schedule.offset >= 0 ? '+' : ''}${schedule.offset} minutes: ${schedule.action ? 'ON' : 'OFF'}`;
                break;
            case 'temperature':
                triggerText = `Temperature ${schedule.condition} ${schedule.value}Â°C: ${schedule.action ? 'ON' : 'OFF'}`;
                break;
            case 'timer':
                triggerText = `Timer: ${schedule.duration} minutes`;
                break;
        }
        const relayNames = ['FAN', 'LIGHT', 'FAN-2', 'DIM-L'];
        const actionText = schedule.action ? 'ON' : 'OFF';
        let nextExecutionHTML = '';
        if (schedule.type === 'sunrise' || schedule.type === 'sunset') {    
            const nextExecution = calculateNextExecutionTime(schedule);
            nextExecutionHTML = `<div class="schedule-trigger"><strong>Next Execution:</strong> <span class="next-execution">${nextExecution}</span></div>`;
        }
        card.innerHTML = `
            <div class="schedule-header">
                <div class="schedule-name"><p class="all-caps">${schedule.id} : ${schedule.name}</p></div>
                <div class="schedule-actions">
                    <button class="schedule-action-btn toggle-btn" data-schedule-id="${schedule.id}" data-current-state="${schedule.enabled}" title="${schedule.enabled ? 'Disable' : 'Enable'}">
                        <i class="fas ${schedule.enabled ? 'fa-pause' : 'fa-play'}"></i>
                    </button>
                    <button class="schedule-action-btn edit-btn" data-schedule-id="${schedule.id}" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="schedule-action-btn delete-btn" data-schedule-id="${schedule.id}" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="schedule-details">
                <div class="schedule-trigger"><strong>Trigger:</strong> ${triggerText}</div>
                <div class="schedule-action"><strong>Action:</strong> ${relayNames[schedule.relay - 1]} ${actionText}</div>
                ${nextExecutionHTML}
                <div class="schedule-status"><strong>Status:</strong> ${schedule.enabled ? 'Enabled' : 'Disabled'}</div>
            </div>
        `;
        schedulesList.appendChild(card);
    });
    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const scheduleId = e.target.closest('.toggle-btn').getAttribute('data-schedule-id');
            const currentState = e.target.closest('.toggle-btn').getAttribute('data-current-state') === 'true';
            toggleSchedule(parseInt(scheduleId), currentState);
        });
    });
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const scheduleId = e.target.closest('.edit-btn').getAttribute('data-schedule-id');
            editSchedule(parseInt(scheduleId));
        });
    });
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const scheduleId = e.target.closest('.delete-btn').getAttribute('data-schedule-id');
            deleteSchedule(parseInt(scheduleId));
        });
    });
}
function editSchedule(scheduleId) {
    db.ref(getDevicePath(`automation/schedule${scheduleId}`)).once('value')
        .then((snapshot) => {
            const scheduleData = snapshot.val();
            if (scheduleData) {
                scheduleData.id = scheduleId;
                showScheduleForm(scheduleData);
            }
        })
        .catch(error => {
            addLogEntry(`Failed to load schedule for editing: ${error.message}`, 'error');
        });
}
// Add schedule button event listener
addScheduleBtn.addEventListener('click', () => {
    showScheduleForm();
});
// --- AUTHENTICATION & SESSION LOGIC ---
function showLogin() {
    dashboardContainer.style.display = 'none';
    loginScreen.style.display = 'flex';
}
function showDashboard(user) {
    localStorage.setItem(SESSION_KEY, 'true');
    userEmailDisplay.textContent = user.email;
    if (isAdminUser(user)) {
        userEmailDisplay.innerHTML = `${user.email} <span style="color: #10b981; font-size: 0.7rem; margin-left: 5px;">(ADMIN)</span>`;
    }
    loginScreen.style.display = 'none';
    dashboardContainer.style.display = 'block';
    addLogEntry(`Multi-room dashboard ${DASHBOARD_VERSION} initialized`, 'info');
    initializeDefaultNames();
    loadRoomAndRelayNames();
    setupDeviceListeners();
    versionInfoEl.textContent = `Dashboard: ${DASHBOARD_VERSION}`;
    loadWeatherData();
    updateUICustomNames();
    initializeFirmwareChecks();
}
function handleAuthError(error) {
    let errorMessage = 'Login failed. Please try again.';
    if (error.code === 'auth/wrong-password' || 
        error.code === 'auth/invalid-credential' ||
        error.code === 'auth/invalid-email' ||
        error.code === 'auth/user-not-found') {
        errorMessage = 'Invalid email or password. Please try again.';
    } else if (error.code === 'auth/too-many-requests') {
        errorMessage = 'Too many failed attempts. Please try again later.';
    } else if (error.code === 'auth/network-request-failed') {
        errorMessage = 'Network error. Please check your internet connection.';
    } else if (error.code === 'auth/user-disabled') {
        errorMessage = 'This account has been disabled.';
    } else {
        console.error('Auth error:', error);
        errorMessage = 'Login failed. !Wrong Email or Password.';
    }
    loginError.textContent = errorMessage;
    addLogEntry(`Authentication failed: ${error.code}`, 'error');
}
// Check for existing session - MODIFIED to check internet first
if (localStorage.getItem(SESSION_KEY) === 'true') {
    initializeApp();
} else {
    showLogin();
}
// Auth state listener - MODIFIED with admin check and internet connection
auth.onAuthStateChanged((user) => {
    if (user) {
        if (isAdminUser(user)) {
            createUserBtn.style.display = 'block';
            addLogEntry('Admin privileges granted - user creation enabled', 'info');
        } else {
            createUserBtn.style.display = 'none';
            addLogEntry('Standard user - user creation disabled', 'info');
        }
        showDashboard(user);
        addLogEntry(`User ${user.email} signed in successfully.`, 'info');
        loadSchedules();
    } else {
        createUserBtn.style.display = 'none';
        if (localStorage.getItem(SESSION_KEY) === 'true') {
            localStorage.removeItem(SESSION_KEY);
            addLogEntry('Session expired. Please log in again.', 'warn');
        }
        showLogin();
    }
});
// Improved login button event listener with internet check
loginBtn.addEventListener('click', async () => {
    if (!isOnline) {
        showErrorModal('No internet connection. Please check your network and try again.');
        return;
    }
    
    loginError.textContent = '';
    if (!loginEmail.value || !loginPassword.value) {
        loginError.textContent = 'Please enter both email and password.';
        return;
    }
    try {
        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing In...';
        await auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value);
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
    } catch (error) {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
        handleAuthError(error);
    }
});
// Logout button event
logoutBtn.addEventListener('click', async () => {
    try {
        await auth.signOut();
        localStorage.removeItem(SESSION_KEY); 
        addLogEntry('User logged out.', 'info');
    } catch (error) {
        handleAuthError(error);
    }
});
// Profile menu toggle
profileBtn.addEventListener('click', (event) => {
    event.stopPropagation();
    profileDropdown.classList.toggle('show');
});
window.addEventListener('click', (event) => {
    if (!event.target.matches('#profileBtn') && !event.target.closest('.dropdown-content')) {
        if (profileDropdown.classList.contains('show')) {
            profileDropdown.classList.remove('show');
        }
    }
});

// --- FACEBOOK-STYLE TAB NAVIGATION LOGIC ---
function initializeFacebookTabs() {
    initializeMainTabs();
    initializeDeviceTabs();
    initializeSettingsTabs();
}

// Main Tabs (Dashboard, Automation, Weather, Logs)
function initializeMainTabs() {
    const tabItems = document.querySelectorAll('#facebookTabs .tab-item');
    const tabContents = document.querySelectorAll('.tab-content');
    const tabSlider = document.getElementById('tabSlider');
    
    updateTabSlider(tabItems, tabSlider);
    
    tabItems.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            
            // Remove active class from all tabs
            tabItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked tab
            tab.classList.add('active');
            
            // Update room-specific styling
            updateTabStyling(tabItems);
            
            // Update slider position
            updateTabSlider(tabItems, tabSlider);
            
            // Hide all tab contents
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            const activeContent = document.getElementById(tabId);
            if (activeContent) {
                setTimeout(() => {
                    activeContent.classList.add('active');
                }, 50);
            }
            
            // Load specific content based on tab
            handleTabContent(tabId);
        });
    });
}

// Device Tabs (Room-1, Room-2, Room-3, Room-4)
function initializeDeviceTabs() {
    const deviceTabs = document.querySelectorAll('#facebookDeviceTabs .device-tab');
    const deviceTabSlider = document.getElementById('deviceTabSlider');
    
    updateDeviceTabSlider(deviceTabs, deviceTabSlider);
    
    deviceTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const deviceId = tab.getAttribute('data-device');
            
            // Remove active class from all device tabs
            deviceTabs.forEach(item => {
                item.classList.remove('active-room-1', 'active-room-2', 'active-room-3', 'active-room-4');
            });
            
            // Add active class to clicked tab
            const roomNum = deviceId.split('_')[1];
            tab.classList.add(`active-room-${roomNum}`);
            
            // Update slider position
            updateDeviceTabSlider(deviceTabs, deviceTabSlider);
            
            // Switch device
            switchDevice(deviceId);
        });
    });
}

// Settings Tabs
function initializeSettingsTabs() {
    const settingsTabs = document.querySelectorAll('#facebookSettingsTabs .settings-tab');
    const settingsTabSlider = document.getElementById('settingsTabSlider');
    
    updateSettingsTabSlider(settingsTabs, settingsTabSlider);
    
    settingsTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const room = tab.getAttribute('data-room');
            
            // Remove active class from all settings tabs
            settingsTabs.forEach(t => t.classList.remove('active'));
            
            // Add active class to clicked tab
            tab.classList.add('active');
            
            // Update slider position
            updateSettingsTabSlider(settingsTabs, settingsTabSlider);
            
            // Update active panel
            settingsPanels.forEach(panel => panel.classList.remove('active'));
            const panelId = `${room.toLowerCase()}Settings`;
            const targetPanel = document.getElementById(panelId);
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
        });
    });
}

// Update slider position functions
function updateTabSlider(tabItems, slider) {
    const activeTab = document.querySelector('#facebookTabs .tab-item.active');
    if (activeTab && slider) {
        const tabWidth = activeTab.offsetWidth;
        const tabLeft = activeTab.offsetLeft;
        
        slider.style.width = `${tabWidth - 16}px`;
        slider.style.left = `${tabLeft + 8}px`;
        
        // Update slider color based on current room
        const roomNum = currentDevice.split('_')[1];
        slider.className = `tab-slider room-${roomNum}`;
    }
}

function updateDeviceTabSlider(deviceTabs, slider) {
    const activeTab = document.querySelector('#facebookDeviceTabs .device-tab.active-room-1, #facebookDeviceTabs .device-tab.active-room-2, #facebookDeviceTabs .device-tab.active-room-3, #facebookDeviceTabs .device-tab.active-room-4');
    if (activeTab && slider) {
        const tabWidth = activeTab.offsetWidth;
        const tabLeft = activeTab.offsetLeft;
        
        slider.style.width = `${tabWidth - 16}px`;
        slider.style.left = `${tabLeft + 8}px`;
        
        // Update slider color based on active room
        const roomNum = currentDevice.split('_')[1];
        slider.className = `device-tab-slider room-${roomNum}`;
    }
}

function updateSettingsTabSlider() {
    const settingsTabs = document.querySelectorAll('#facebookSettingsTabs .settings-tab');
    const slider = document.getElementById('settingsTabSlider');
    const activeTab = document.querySelector('#facebookSettingsTabs .settings-tab.active');
    
    if (activeTab && slider) {
        const tabWidth = activeTab.offsetWidth;
        const tabLeft = activeTab.offsetLeft;
        
        slider.style.width = `${tabWidth - 16}px`;
        slider.style.left = `${tabLeft + 8}px`;
        
        // Update slider color based on active tab
        if (activeTab.classList.contains('room-1-color')) {
            slider.className = `settings-tab-slider room-1`;
        } else if (activeTab.classList.contains('room-2-color')) {
            slider.className = `settings-tab-slider room-2`;
        } else if (activeTab.classList.contains('room-3-color')) {
            slider.className = `settings-tab-slider room-3`;
        } else if (activeTab.classList.contains('room-4-color')) {
            slider.className = `settings-tab-slider room-4`;
        }
    }
}

// Update tab styling based on current room
function updateTabStyling(tabItems) {
    const roomNum = currentDevice.split('_')[1];
    
    tabItems.forEach(tab => {
        // Remove all room-specific classes
        tab.classList.remove('room-1', 'room-2', 'room-3', 'room-4');
        
        // Add current room class to active tab
        if (tab.classList.contains('active')) {
            tab.classList.add(`room-${roomNum}`);
        }
    });
}

// Handle tab-specific content loading
function handleTabContent(tabId) {
    switch(tabId) {
        case 'automation':
            loadSchedules();
            break;
        case 'weather':
            loadWeatherData();
            break;
        case 'logs':
            // Logs are automatically updated
            break;
        default:
            // Dashboard doesn't need special handling
            break;
    }
}

// Update all tabs when device changes
function updateAllTabsOnDeviceChange() {
    // Update main tabs
    const mainTabItems = document.querySelectorAll('#facebookTabs .tab-item');
    updateTabStyling(mainTabItems);
    updateTabSlider(mainTabItems, document.getElementById('tabSlider'));
    
    // Update device tabs
    const deviceTabs = document.querySelectorAll('#facebookDeviceTabs .device-tab');
    updateDeviceTabSlider(deviceTabs, document.getElementById('deviceTabSlider'));
}

// Listen for device changes
const originalSwitchDevice = switchDevice;
switchDevice = function(deviceId) {
    originalSwitchDevice(deviceId);
    updateAllTabsOnDeviceChange();
};

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    initializeFacebookTabs();
    updateAllTabsOnDeviceChange();
});

// Also initialize after Firebase auth
if (typeof auth !== 'undefined') {
    auth.onAuthStateChanged((user) => {
        if (user) {
            setTimeout(() => {
                initializeFacebookTabs();
                updateAllTabsOnDeviceChange();
            }, 100);
        }
    });
}

// --- FIREBASE CONNECTION LISTENER ---
db.ref('.info/connected').on('value', (snap) => {
    const wasConnected = clientConnected;
    clientConnected = snap.val();
    if (clientConnected && !wasConnected) {
        addLogEntry('Client connected to Firebase.', 'info');
        setupDeviceListeners();
    } else if (!clientConnected && wasConnected) {
        addLogEntry('Client lost connection to Firebase.', 'error');
    }
    updateStatusDisplay();
});
// --- INITIALIZATION ---
// Set initial device and initialize
switchDevice('ROOM_1');
addLogEntry('Smart Home initialized successfully. Ready to control 4 devices.', 'info');
<!-- Password Toggle Script -->
document.querySelectorAll('input[type="password"]').forEach(input => {
  const wrapper = document.createElement('div');
  wrapper.style.position = 'relative';
  input.parentNode.insertBefore(wrapper, input);
  wrapper.appendChild(input);
  const icon = document.createElement('i');
  icon.className = 'fa fa-eye';
  icon.style.position = 'absolute';
  icon.style.right = '10px';
  icon.style.top = '50%';
  icon.style.transform = 'translateY(-50%)';
  icon.style.cursor = 'pointer';
  icon.style.color = '#94a3b8';
  wrapper.appendChild(icon);
  icon.addEventListener('click', () => {
    if (input.type === 'password') {
      input.type = 'text';
      icon.classList.remove('fa-eye');
      icon.classList.add('fa-eye-slash');
    } else {
      input.type = 'password';
      icon.classList.remove('fa-eye-slash');
      icon.classList.add('fa-eye');
    }
  });
});
// --- WEATHER FETCH & RTDB UPDATE (Open-Meteo) ---
const WEATHER_LAT = 23.8103;
const WEATHER_LON = 90.4125;
async function loadWeatherData1() {
  try {
    addLogEntry("Fetching weather data from Open-Meteo...", "weather");
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${WEATHER_LAT}&longitude=${WEATHER_LON}&current=wind_speed_10m,precipitation`;
    const response = await fetch(url);
    const data = await response.json();
    const current = data.current || {};
    const windSpeed = current.wind_speed_10m || 0;
    const rainAmount = current.precipitation || 0;
    const rainStatus = rainAmount > 0 ? "Raining" : "No Rain";
    document.getElementById("windSpeed").textContent = windSpeed.toFixed(1);
    document.getElementById("rainStatus").textContent = rainStatus;
   // Save to Firebase RTDB
const now = new Date();
const formattedTime = now.toLocaleTimeString("en-US", {
  hour: "2-digit",
  minute: "2-digit",
  second: "2-digit",
  hour12: true
});
db.ref("HOME/ROOM_1/weather").update({  windSpeed: windSpeed,  rainStatus: rainStatus,  updatedAt: formattedTime});
db.ref("HOME/ROOM_2/weather").update({  windSpeed: windSpeed,  rainStatus: rainStatus,  updatedAt: formattedTime});
db.ref("HOME/ROOM_3/weather").update({  windSpeed: windSpeed,  rainStatus: rainStatus,  updatedAt: formattedTime});
db.ref("HOME/ROOM_4/weather").update({  windSpeed: windSpeed,  rainStatus: rainStatus,  updatedAt: formattedTime});      
    addLogEntry(`Weather updated: Wind ${windSpeed} km/h, ${rainStatus}`, "weather");
  } catch (error) {
    console.error("Weather fetch error:", error);
    addLogEntry("Weather fetch failed", "error", "weather");
  }
}
// Refresh button handler
document.getElementById("weatherRefreshBtn").addEventListener("click",loadWeatherData1, loadWeatherData1);
// Auto-load weather every 10 minutes
setInterval(loadWeatherData1, 10 * 60 * 1000);
// ADDED: Event Listeners for Firmware Updates
firmwareBadge.addEventListener('click', showFirmwareUpdateModal);
closeFirmwareUpdateBtn.addEventListener('click', closeFirmwareUpdateModal);
// ADDED: Function to Update Firmware Badge
function updateFirmwareBadge() {
  const updateCount = Object.values(firmwareUpdates).filter(room => room.available).length;
  if (updateCount > 0) {
    firmwareBadge.style.display = 'flex';
    firmwareBadgeCount.textContent = updateCount;
  } else {
    firmwareBadge.style.display = 'none';
  }
}
// ADDED: Function to Show Firmware Update Modal
function showFirmwareUpdateModal() {
  const updateCount = Object.values(firmwareUpdates).filter(room => room.available).length;
  if (updateCount === 0) {
    firmwareUpdateList.style.display = 'none';
    noFirmwareUpdates.style.display = 'block';
  } else {
    firmwareUpdateList.style.display = 'block';
    noFirmwareUpdates.style.display = 'none';
    firmwareUpdateList.innerHTML = '';
    devices.forEach(device => {
      if (firmwareUpdates[device].available) {
        const roomNum = device.split('_')[1];
        const roomName = roomNames[device] || device;
        const card = document.createElement('div');
        card.className = `firmware-room-card room-${roomNum}-card`;
        card.innerHTML = `
          <div class="firmware-room-header">
            <div class="firmware-room-name room-${roomNum}-name">${roomName}</div>
<div class="firmware-actions">
            <button class="firmware-action-btn firmware-skip-btn" data-device="${device}">
              Skip
            </button>
            <button class="firmware-action-btn firmware-update-btn" data-device="${device}">
              Update Now
            </button>
          </div>
          </div>
          <div class="firmware-version-info">
            <div class="firmware-version-item">
              <div class="firmware-version-label">Current Version</div>
              <div class="firmware-version-value">${firmwareUpdates[device].current}</div>
            </div>
            <div class="firmware-version-item">
              <div class="firmware-version-label">Latest Version</div>
              <div class="firmware-version-value">${firmwareUpdates[device].latest}</div>
            </div>
          </div>
        `;
        firmwareUpdateList.appendChild(card);
      }
    });
    document.querySelectorAll('.firmware-skip-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const device = e.target.getAttribute('data-device');
        skipFirmwareUpdate(device);
      });
    });
    document.querySelectorAll('.firmware-update-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const device = e.target.getAttribute('data-device');
        applyFirmwareUpdate(device);
      });
    });
  }
  firmwareUpdateModal.classList.add('show');
}
// ADDED: Function to Close Firmware Update Modal
function closeFirmwareUpdateModal() {
  firmwareUpdateModal.classList.remove('show');
}
// MODIFIED: Function to Skip Firmware Update
function skipFirmwareUpdate(device) {
  try {
    db.ref(`HOME/${device}/updateRequest`).set(false);
    db.ref(`HOME/${device}/updateStatus`).set('skipped');
    firmwareUpdates[device].available = false;
    updateFirmwareBadge();
    showFirmwareUpdateModal();
    addLogEntry(`Firmware update skipped for ${roomNames[device] || device}`, 'info');
  } catch (error) {
    addLogEntry(`Failed to skip firmware update for ${device}: ${error.message}`, 'error');
    showErrorModal('Failed to skip update. Please try again.');
  }
}
// ADDED: Function to Apply Firmware Update
async function applyFirmwareUpdate(device) {
  try {
    await db.ref(`HOME/${device}/updateRequest`).set(true);
    await db.ref(`HOME/${device}/updateStatus`).set('requested');
    firmwareUpdates[device].available = false;
    updateFirmwareBadge();
    showFirmwareUpdateModal();
    addLogEntry(`Firmware update requested for ${roomNames[device] || device} (v${firmwareUpdates[device].current} -> v${firmwareUpdates[device].latest})`, 'info');
    showErrorModal(`Update requested for ${roomNames[device] || device}. The device will update shortly.`);
  } catch (error) {
    addLogEntry(`Failed to request firmware update for ${device}: ${error.message}`, 'error');
    showErrorModal('Failed to send update request. Please try again.');
  }
}

// FIXED: Individual Firmware Check Function per Room with proper version comparison
async function checkRoomFirmwareUpdate(room) {
  try {
    const versionURL = `https://jahangirnrl.github.io/nrl/firmware/${room}/version.txt`;
    
    const resp = await fetch(versionURL, { cache: "no-store" });
    if (!resp.ok) throw new Error(`Failed to fetch version info for ${room}`);
    const latestVersion = (await resp.text()).trim();

    const pathCandidates = [
      `HOME/${room}/device/firmwareVersion`,
      `HOME/${room}/device/firmware`,
      `HOME/${room}/firmwareVersion`,
      `HOME/${room}/firmware`,
      `HOME/${room}/device/firmware_version`
    ];
    
    let currentVersion = null;
    for (const p of pathCandidates) {
      const snap = await db.ref(p).get();
      if (snap && snap.exists()) {
        currentVersion = snap.val();
        break;
      }
    }
    
    if (currentVersion === null) currentVersion = '--';

    if (latestVersion && currentVersion !== '--' && currentVersion !== latestVersion) {
      const isUpdateAvailable = (() => {
        try {
          const cleanCurrent = currentVersion.replace(/^v/, '').trim();
          const cleanLatest = latestVersion.replace(/^v/, '').trim();
          
          const currentParts = cleanCurrent.split('.').map(part => {
            const num = parseInt(part, 10);
            return isNaN(num) ? part : num;
          });
          
          const latestParts = cleanLatest.split('.').map(part => {
            const num = parseInt(part, 10);
            return isNaN(num) ? part : num;
          });
          
          for (let i = 0; i < Math.max(currentParts.length, latestParts.length); i++) {
            const currentPart = currentParts[i] || 0;
            const latestPart = latestParts[i] || 0;
            
            if (currentPart < latestPart) return true;
            if (currentPart > latestPart) return false;
          }
          
          return false;
        } catch (error) {
          console.warn('Version comparison failed, using string comparison:', error);
          const cleanCurrent = currentVersion.replace(/^v/, '').trim();
          const cleanLatest = latestVersion.replace(/^v/, '').trim();
          return cleanCurrent !== cleanLatest;
        }
      })();
      
      if (isUpdateAvailable) {
        firmwareUpdates[room] = {
          available: true,
          current: currentVersion,
          latest: latestVersion
        };
        addLogEntry(
          `Firmware update available for ${roomNames[room] || room}: ${currentVersion} â ${latestVersion}`,
          'info'
        );
      } else {
        firmwareUpdates[room] = {
          available: false,
          current: currentVersion,
          latest: latestVersion
        };
        await db.ref(`HOME/${room}/updateRequest`).set(false);
        await db.ref(`HOME/${room}/updateStatus`).set('up_to_date');
        addLogEntry(
          `Firmware is up to date for ${roomNames[room] || room}: ${currentVersion} (latest: ${latestVersion})`,
          'info'
        );
      }
    } else {
      firmwareUpdates[room] = {
        available: false,
        current: currentVersion,
        latest: latestVersion
      };
      await db.ref(`HOME/${room}/updateRequest`).set(false);
      await db.ref(`HOME/${room}/updateStatus`).set('up_to_date');
      
      if (currentVersion === '--') {
        addLogEntry(`Firmware version unknown for ${roomNames[room] || room}`, 'warn');
      } else if (currentVersion === latestVersion) {
        addLogEntry(`Firmware is up to date for ${roomNames[room] || room}: ${currentVersion}`, 'info');
      }
    }

    updateFirmwareBadge();
  } catch (err) {
    console.error(`checkRoomFirmwareUpdate error for ${room}:`, err);
    addLogEntry(`Firmware check failed for ${room}: ${err.message}`, 'error');
  }
}
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

// MODIFIED: Initialize firmware checks for all devices
function initializeFirmwareChecks() {
  devices.forEach(device => {
    checkRoomFirmwareUpdate(device);
  });
  setInterval(() => {
    devices.forEach(device => {
      checkRoomFirmwareUpdate(device);
    });
  }, 30 * 60 * 1000);
}

// Close firmware modal when clicking outside
window.addEventListener('click', (event) => {
  if (event.target === firmwareUpdateModal) {
    closeFirmwareUpdateModal();
  }
});
</script>
</body>
</html>
