<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-Room Dashboard</title>
<link rel="icon" type="image/x-icon" href="https://cdn-icons-png.flaticon.com/512/7733/7733361.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
  body {
    margin:0; padding:0; 
    font-family: "Inter", sans-serif;
    background:#0f172a;
    color:#e2e8f0;
    line-height:1.4;
    font-size: 0.95rem; 
  }

  #dashboardContainer {
    padding: 10px;
  }

  /* --- LOGIN SCREEN STYLES --- */
  #loginScreen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    box-sizing: border-box;
    text-align: center;
    background: #1e293b; 
  }
  .login-card {
    background: #0f172a;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    max-width: 350px;
    width: 100%;
  }
  .login-card h2 {
    color: #38bdf8;
    margin-bottom: 20px;
    font-size: 1.8rem;
  }
  .login-input {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 1px solid #334155;
    border-radius: 6px;
    background: #1e293b;
    color: #f1f5f9;
    font-size: 1rem;
    box-sizing: border-box;
  }
  .login-input:focus { outline: none; border-color: #38bdf8; }
  .login-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 6px;
    background: #10b981;
    color: #042f2e;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  .login-btn:hover { background: #059669; }
  #loginError {
    color: #ef4444;
    margin-top: 10px;
    font-size: 0.85rem;
  }

  /* --- HEADER AND PROFILE MENU STYLES --- */
  header {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    margin-bottom: 12px;
    padding: 0 5px; 
    position: relative; 
  }
  header h1 {
    color:#38bdf8; 
    margin:0; 
    font-size:1.6rem; 
    text-align: center;
  }
  header h1 i {
    margin-right: 8px;
  }
  .header-center-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      grid-column: 2;
      width: 100%;
  }
  .profile-menu {
    grid-column: 1;
    justify-self: start;
    position: relative;
    z-index: 02;
  }
  .profile-btn {
    background: transparent;
    border: none;
    color: #38bdf8;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 5px;
  }
  .dropdown-content {
    display: none;
    position: absolute;
    margin-top: 0;
    left: 0;
    background-color: #1e293b;
    min-width: 220px;
    box-shadow: 0 8px 16px 0 rgba(0,0,0,0.4);
    border-radius: 8px;
    z-index: 20;
    padding: 15px;
    border: 1px solid #334155;
    text-align: left;
  }
  .dropdown-content.show {
    display: block;
  }
  .dropdown-content p {
    margin: 0 0 15px 0;
    color: #94a3b8;
    font-size: 0.85rem;
    word-break: break-word;
  }
  .dropdown-btn {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background 0.2s;
    margin-bottom: 10px;
  }
  .dropdown-btn:last-child {
    margin-bottom: 0;
  }
  .logout-btn { 
    background: #ef4444;
    color: #fff;
  }
  .logout-btn:hover { background: #b91c1c; }
  .restart-btn {
    background: #f59e0b;
    color: #0f172a;
  }
  .restart-btn:hover { background: #d97706; }
  
  /* Device Selection Tabs */
  .device-tabs {
    display: flex;
    gap: 6px;
    margin-top: 6px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .device-tab {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    background: #1e293b;
    color: #94a3b8;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    font-size: 0.85rem;
    border: 2px solid transparent;
  }
  .device-tab:hover {
    background: #334155;
    color: #e2e8f0;
  }
  .device-tab.active-room-1 {
    background: #10b981;
    color: #042f2e;
    border-color: #10b981;
  }
  .device-tab.active-room-2 {
    background: #38bdf8;
    color: #0f172a;
    border-color: #38bdf8;
  }
  .device-tab.active-room-3 {
    background: #f59e0b;
    color: #0f172a;
    border-color: #f59e0b;
  }
  .device-tab.active-room-4 {
    background: #8b5cf6;
    color: #f1f5f9;
    border-color: #8b5cf6;
  }

  /* Main Tabs */
  .tabs { 
    display:flex; 
    gap:6px; 
    margin-top:12px; 
    justify-content: center;
    flex-wrap: wrap;
  }
  .tab-btn { 
    padding:6px 12px; 
    border:none; 
    border-radius:6px; 
    background:#1e293b; 
    color:#94a3b8; 
    cursor:pointer; 
    font-weight:600; 
    transition: background 0.2s, color 0.2s;
    font-size:0.8rem; 
    white-space: nowrap;
  }
  .tab-btn:hover { background:#334155; }
  
  /* Room-specific active tab colors */
  .tab-btn.active.room-1-active { 
    background:#10b981; 
    color:#042f2e; 
  }
  .tab-btn.active.room-2-active { 
    background:#38bdf8; 
    color:#0f172a; 
  }
  .tab-btn.active.room-3-active { 
    background:#f59e0b; 
    color:#0f172a; 
  }
  .tab-btn.active.room-4-active { 
    background:#8b5cf6; 
    color:#f1f5f9; 
  }
  
  .tab-content { display:none; padding-top: 6px; }
  .tab-content.active { display:block; }
  
  /* Status styles */
  .status { 
    display:inline-block; 
    padding:4px 10px; 
    border-radius:16px; 
    background:#ef4444;
    color:#fff; 
    font-weight:600; 
    font-size:0.75rem; 
    margin-top:10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: background 0.3s;
    text-align: center;
  }
  .status.online.room-1-online { background:#10b981; }
  .status.online.room-2-online { background:#38bdf8; }
  .status.online.room-3-online { background:#f59e0b; }
  .status.online.room-4-online { background:#8b5cf6; }

  /* Version Info */
  .version-info-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-top: 5px;
    font-size: 0.7rem;
  }
  .dashboard-version.room-1-version { color: #10b981; }
  .dashboard-version.room-2-version { color: #38bdf8; }
  .dashboard-version.room-3-version { color: #f59e0b; }
  .dashboard-version.room-4-version { color: #8b5cf6; }
  
  .firmware-version.room-1-firmware { color: #10b981; }
  .firmware-version.room-2-firmware { color: #38bdf8; }
  .firmware-version.room-3-firmware { color: #f59e0b; }
  .firmware-version.room-4-firmware { color: #8b5cf6; }

  .info-main { 
    display:grid; 
    grid-template-columns: 1fr 1fr; 
    gap:8px; 
    margin-bottom:12px; 
  }
  .panel { 
    background: rgba(30,41,59,0.9); 
    border-radius:10px; 
    padding:10px; 
    text-align:center; 
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
    border: 1px solid #334155;
  }
  .panel .label { 
    font-size:0.65rem; 
    color:#94a3b8; 
    margin-bottom:2px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .panel .value { 
    font-weight:700; 
    font-size:1rem; 
    color:#f1f5f9; 
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .relays { 
    display:flex; 
    justify-content:center; 
    gap:16px; 
    flex-wrap:wrap; 
    margin-bottom:20px; 
    padding: 6px 0;
  }
  .relay-btn { 
    width:65px; 
    height:65px; 
    border-radius:50%; 
    border:3px solid #475569; 
    display:flex; 
    flex-direction: column;
    justify-content:center; 
    align-items:center; 
    background:#1e293b; 
    color:#94a3b8; 
    font-weight:600; 
    font-size:0.85rem;
    cursor:pointer; 
    transition:0.3s; 
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
  }
  .relay-btn.on { 
    background:#10b981; 
    border-color:#34d399; 
    color:#042f2e; 
    box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
  }

  /* Device-specific relay colors */
  .relay-btn.room-1.on { background: #10b981; border-color: #34d399; }
  .relay-btn.room-2.on { background: #38bdf8; border-color: #7dd3fc; }
  .relay-btn.room-3.on { background: #f59e0b; border-color: #fbbf24; }
  .relay-btn.room-4.on { background: #8b5cf6; border-color: #a78bfa; }

  /* Switch Styles */
  .switch-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(30, 41, 59, 0.7);
    border-radius: 8px;
    border: 1px solid #334155;
  }
  .switch-label {
    color: #94a3b8;
    font-weight: 600;
    font-size: 0.9rem;
  }
  .switch {
    width: 50px;
    height: 24px;
    border-radius: 12px;
    background: #ef4444;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
  }
  .switch.on {
    background: #10b981;
  }
  .switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #fff;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.4);
  }
  .switch.on::after {
    transform: translateX(26px);
  }

  /* Lock Switch Styles */
  .lock-switch {
    width: 50px;
    height: 24px;
    border-radius: 12px;
    background: #10b981; /* Green when unlocked */
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
  }
  .lock-switch.locked {
    background: #ef4444; /* Red when locked */
  }
  .lock-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #fff;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.4);
  }
  .lock-switch.locked::after {
    transform: translateX(26px);
  }

  /* Current Device Indicator */
  .current-device {
    text-align: center;
    margin: 8px 0;
    font-size: 0.9rem;
    font-weight: 600;
    color: #38bdf8;
  }

  /* Device-specific theme colors */
  .room-1-theme { color: #10b981; }
  .room-2-theme { color: #38bdf8; }
  .room-3-theme { color: #f59e0b; }
  .room-4-theme { color: #8b5cf6; }

  /* Basic styles for other components */
  .automation-content-wrapper {
    max-width: 500px; 
    margin: 0 auto; 
  }

  /* NEW: Automation Schedule Styles */
  .automation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(30, 41, 59, 0.9);
    border-radius: 8px;
    border: 1px solid #334155;
  }

  .add-schedule-btn {
    background: #10b981;
    color: #042f2e;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .add-schedule-btn:hover {
    background: #059669;
  }

  .schedule-card {
    background: rgba(30, 41, 59, 0.9);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 12px;
    border: 1px solid #334155;
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
  }

  .schedule-card.enabled {
    border-left: 4px solid #10b981;
  }

  .schedule-card.disabled {
    border-left: 4px solid #ef4444;
    opacity: 0.7;
  }

  .schedule-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .schedule-name {
    font-weight: 700;
    color: #38bdf8;
    font-size: 1rem;
  }

  .schedule-actions {
    display: flex;
    gap: 8px;
  }

  .schedule-action-btn {
    background: none;
    border: none;
    color: #94a3b8;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: color 0.2s;
  }

  .schedule-action-btn:hover {
    color: #e2e8f0;
  }

  .schedule-details {
    font-size: 0.85rem;
    color: #94a3b8;
    margin-bottom: 10px;
  }

  .schedule-trigger, .schedule-action {
    margin-bottom: 5px;
  }

  /* NEW: Next Execution Time Styles */
  .next-execution {
    color: #10b981;
    font-weight: 600;
    background: rgba(16, 185, 129, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
    margin-top: 5px;
    display: inline-block;
  }

  /* Schedule Form Styles */
  .schedule-form {
    background: rgba(30, 41, 59, 0.95);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    border: 2px solid #38bdf8;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-label {
    display: block;
    margin-bottom: 5px;
    color: #94a3b8;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .form-input, .form-select {
    width: 100%;
    padding: 8px;
    border: 1px solid #475569;
    border-radius: 6px;
    background: #1e293b;
    color: #f1f5f9;
    font-size: 0.9rem;
  }

  .form-input:focus, .form-select:focus {
    outline: none;
    border-color: #38bdf8;
  }

  .trigger-fields {
    background: rgba(55, 65, 81, 0.5);
    padding: 10px;
    border-radius: 6px;
    margin-top: 8px;
  }

  .days-selector {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 8px;
  }

  .day-checkbox {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.8rem;
  }

  .form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 15px;
  }

  .save-btn {
    background: #10b981;
    color: #042f2e;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 600;
    cursor: pointer;
  }

  .cancel-btn {
    background: #64748b;
    color: #f1f5f9;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-weight: 600;
    cursor: pointer;
  }

  /* Weather Tab Styles - 2x2 Grid Layout */
  .weather-content-wrapper {
    max-width: 400px; 
    margin: 0 auto; 
  }
  .weather-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 15px;
  }
  .weather-tile {
    background: rgba(30,41,59,0.9);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #334155;
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 120px;
  }
  .weather-tile .title {
    font-weight: 800;
    margin-bottom: 8px;
    color: #38bdf8;
    font-size: 1rem;
    text-align: center;
  }
  .weather-tile .value {
    font-weight: 700;
    font-size: 1.5rem;
    color: #f1f5f9;
  }
  .weather-tile .unit {
    font-size: 0.9rem;
    color: #94a3b8;
    margin-left: 4px;
  }
  .weather-tile .icon {
    font-size: 2rem;
    margin-bottom: 8px;
    color: #38bdf8;
  }
  .weather-location {
    text-align: center;
    margin-bottom: 15px;
    color: #94a3b8;
    font-size: 0.9rem;
  }
  .weather-refresh-btn {
    background: #38bdf8;
    color: #0f172a;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 10px;
    transition: background 0.2s;
    width: 100%;
  }
  .weather-refresh-btn:hover {
    background: #0ea5e9;
  }
  .weather-refresh-btn:disabled {
    background: #64748b;
    cursor: not-allowed;
  }
  .weather-loading {
    text-align: center;
    color: #94a3b8;
    font-style: italic;
  }
  .weather-error {
    text-align: center;
    color: #fbbf24;
    font-size: 0.85rem;
    margin-top: 10px;
    padding: 8px;
    background: rgba(251, 191, 36, 0.1);
    border-radius: 6px;
    border: 1px solid rgba(251, 191, 36, 0.3);
  }
  .weather-source {
    text-align: center;
    font-size: 0.7rem;
    color: #64748b;
    margin-top: 5px;
  }

  .log-viewer {
    height: 350px; 
    overflow-y: scroll;
    background: #1e293b;
    border-radius: 8px;
    padding: 8px;
    border: 1px solid #334155;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 0.8rem; 
    color: #cbd5e1;
  }

  /* Log entry styles */
  .log-entry {
    border-bottom: 1px dotted #334155;
    padding: 3px 0;
  }
  .log-entry:last-child { border-bottom: none; }
  .log-entry-time {
    color: #94a3b8;
    margin-right: 6px;
  }
  .log-entry-type-info { color: #38bdf8; }
  .log-entry-type-warn { color: #fbbf24; }
  .log-entry-type-error { color: #ef4444; }
  .log-entry-type-relay { color: #10b981; }
  .log-entry-type-device { color: #8b5cf6; }
  .log-entry-type-rtdb { color: #f97316; }
  .log-entry-type-weather { color: #06b6d4; }
  .log-entry-type-automation { color: #f97316; }
</style>
</head>
<body>

<div id="loginScreen">
  <div class="login-card">
    <h2>Multi-Room Dashboard</h2>
    <input type="email" id="loginEmail" class="login-input" placeholder="Email">
    <input type="password" id="loginPassword" class="login-input" placeholder="Password">
    <button id="loginBtn" class="login-btn">Sign In</button>
    <div id="loginError"></div>
    <button id="createAccountBtn" class="login-btn" style="margin-top: 10px; background: #94a3b8;">Create Account (New User)</button>
  </div>
</div>

<div id="dashboardContainer" style="display: none;">
  <header>
    <div class="profile-menu">
        <button class="profile-btn" id="profileBtn">⋮</button>
        <div class="dropdown-content" id="profileDropdown">
            <p>Logged in as:</p>
            <p id="userEmailDisplay">user@gmail.com</p>
            
            <!-- BEEP Switch -->
            <div class="switch-container">
                <span class="switch-label">MUTE / UNMUTE</span>
                <div class="switch" id="beepSwitch"></div>
            </div>
            
            <!-- IR Lock Switch -->
            <div class="switch-container">
                <span class="switch-label">IR LOCK</span>
                <div class="lock-switch" id="irLockSwitch"></div>
            </div>

            <!-- Physical Button Lock Switch -->
            <div class="switch-container">
                <span class="switch-label">BUTTON LOCK</span>
                <div class="lock-switch" id="buttonLockSwitch"></div>
            </div>
            
            <button class="dropdown-btn restart-btn" id="restartBtn">DEVICE RESTART</button>
            <button class="dropdown-btn logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>
    
    <div class="header-center-content">
      <h1><i class="fa-solid fa-house-chimney"></i> Multi-Room Control</h1>
      
      <!-- Device Selection Tabs -->
      <div class="device-tabs">
        <button class="device-tab active-room-1" data-device="ROOM_1">Room-1</button>
        <button class="device-tab" data-device="ROOM_2">Room-2</button>
        <button class="device-tab" data-device="ROOM_3">Room-3</button>
        <button class="device-tab" data-device="ROOM_4">Room-4</button>
      </div>

      <!-- Current Device Indicator -->
      <div class="current-device room-1-theme" id="currentDeviceDisplay">Controlling: ROOM-1</div>
      
      <!-- Main Tabs -->
      <div class="tabs">
        <button class="tab-btn active room-1-active" data-tab="dashboard">Dashboard</button>
        <button class="tab-btn" data-tab="automation">Automation</button>
        <button class="tab-btn" data-tab="weather">Weather</button>
        <button class="tab-btn" data-tab="logs">Logs</button>
      </div>
      
      <div class="version-info-container">
        <div class="dashboard-version room-1-version" id="versionInfo">Dashboard: v2.0.0</div>
        <div id="status" class="status">Offline</div>
        <div class="firmware-version room-1-firmware" id="firmwareInfo">Firmware: --</div>
      </div>
    </div>
    
    <div></div> 
  </header>

  <div id="dashboard" class="tab-content active">
    <div class="info-main">
      <div class="panel"><div class="label">IP</div><div id="ip" class="value">--</div></div>
      <div class="panel"><div class="label">MAC</div><div id="mac" class="value">--</div></div>
      <div class="panel"><div class="label">SSID</div><div id="ssid" class="value">--</div></div>
      <div class="panel"><div class="label">Uptime</div><div id="uptime" class="value">--</div></div>
      <div class="panel"><div class="label">SunRise</div><div id="sunrise" class="value">--:--</div></div>
      <div class="panel"><div class="label">SunSet</div><div id="sunset" class="value">--:--</div></div>
    </div>

    <div class="relays">
      <div id="r1" class="relay-btn">FAN</div>
      <div id="r2" class="relay-btn">LIGHT</div>
      <div id="r3" class="relay-btn">FAN-2</div>
      <div id="r4" class="relay-btn">DIM-L</div>
    </div>

    <footer class="info-main">
      <div class="panel"><div class="label">Last Update (Human)</div><div id="lastUpdateHuman" class="value">--:--</div></div>
      <div class="panel"><div class="label">Last Update (Timestamp)</div><div id="lastUpdate" class="value">--:--</div></div>
    </footer>
  </div>

  <div id="automation" class="tab-content">
    <div class="automation-content-wrapper">
      <div class="automation-header">
        <h3 style="color: #38bdf8; margin: 0;">Automation Schedules</h3>
        <button class="add-schedule-btn" id="addScheduleBtn">
          <i class="fas fa-plus"></i> Add Schedule
        </button>
      </div>

      <div id="scheduleFormContainer" style="display: none;"></div>
      <div id="schedulesList"></div>
    </div>
  </div>

  <div id="weather" class="tab-content">
    <div class="weather-content-wrapper">
      <div class="weather-location" id="weatherLocation">Loading weather data...</div>
      
      <div class="weather-grid">
        <div class="weather-tile">
          <div class="icon"><i class="fas fa-thermometer-half"></i></div>
          <div class="title">Temperature</div>
          <div class="value"><span id="temperature">--</span><span class="unit">°C</span></div>
        </div>
        <div class="weather-tile">
          <div class="icon"><i class="fas fa-tint"></i></div>
          <div class="title">Humidity</div>
          <div class="value"><span id="humidity">--</span><span class="unit">%</span></div>
        </div>
        
        <div class="weather-tile">
          <div class="icon"><i class="fas fa-wind"></i></div>
          <div class="title">Wind Speed</div>
          <div class="value"><span id="windSpeed">--</span><span class="unit">km/h</span></div>
        </div>
        <div class="weather-tile">
          <div class="icon"><i class="fas fa-cloud-rain"></i></div>
          <div class="title">Rain Status</div>
          <div class="value"><span id="rainStatus">--</span></div>
        </div>
      </div>
      
      <!-- Weather Refresh Button -->
      <button class="weather-refresh-btn" id="weatherRefreshBtn">
        <i class="fas fa-sync-alt"></i> Refresh Weather Data
      </button>
      
      <div id="weatherSource" class="weather-source"></div>
    </div>
  </div>

  <div id="logs" class="tab-content">
    <div class="log-viewer" id="logViewer">
      <div class="log-entry"><span class="log-entry-time">--:--:--</span><span class="log-entry-type-info">INFO:</span> Dashboard initialized. Please login.</div>
    </div>
  </div>
</div>

<!-- Add Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAei8j8RQXq_zspkohtH40g_gvHUfIx-Uw",
  authDomain: "home-control-df716.firebaseapp.com",
  databaseURL: "https://home-control-df716-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "home-control-df716",
  storageBucket: "home-control-df716.firebasestorage.app",
  messagingSenderId: "956714070689",
  appId: "1:956714070689:web:414179e22a04601349b6e0",
  measurementId: "G-LEHP8KM47D"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// --- GLOBAL STATE & UI ELEMENTS ---
const SESSION_KEY = 'multiroom_session_active';
const DASHBOARD_VERSION = 'v2.0.0';

// Current device state
let currentDevice = 'ROOM_1';
const devices = ['ROOM_1', 'ROOM_2', 'ROOM_3', 'ROOM_4'];

// UI Elements
const loginScreen = document.getElementById('loginScreen');
const dashboardContainer = document.getElementById('dashboardContainer');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginBtn = document.getElementById('loginBtn');
const createAccountBtn = document.getElementById('createAccountBtn');
const loginError = document.getElementById('loginError');
const profileBtn = document.getElementById('profileBtn');
const profileDropdown = document.getElementById('profileDropdown');
const userEmailDisplay = document.getElementById('userEmailDisplay');
const logoutBtn = document.getElementById('logoutBtn');
const beepSwitch = document.getElementById('beepSwitch');
const irLockSwitch = document.getElementById('irLockSwitch');
const buttonLockSwitch = document.getElementById('buttonLockSwitch');
const restartBtn = document.getElementById('restartBtn');
const statusEl = document.getElementById('status');
const versionInfoEl = document.getElementById('versionInfo');
const firmwareInfoEl = document.getElementById('firmwareInfo');
const uptimeEl = document.getElementById('uptime');
const logViewer = document.getElementById('logViewer');
const relayBtns = [document.getElementById('r1'),document.getElementById('r2'),document.getElementById('r3'),document.getElementById('r4')];
const currentDeviceDisplay = document.getElementById('currentDeviceDisplay');
const deviceTabs = document.querySelectorAll('.device-tab');

// Automation elements
const addScheduleBtn = document.getElementById('addScheduleBtn');
const scheduleFormContainer = document.getElementById('scheduleFormContainer');
const schedulesList = document.getElementById('schedulesList');

// Weather elements
const temperatureEl = document.getElementById('temperature');
const humidityEl = document.getElementById('humidity');
const rainStatusEl = document.getElementById('rainStatus');
const windSpeedEl = document.getElementById('windSpeed');
const weatherLocationEl = document.getElementById('weatherLocation');
const weatherSourceEl = document.getElementById('weatherSource');
const weatherRefreshBtn = document.getElementById('weatherRefreshBtn');

// Device-specific state
const deviceStates = {};
devices.forEach(device => {
  deviceStates[device] = { 
    online: false, 
    lastHeartbeat: null, 
    relays: [false, false, false, false],
    firmware: '--',
    ip: '--',
    mac: '--',
    ssid: '--',
    uptime: '--',
    sunrise: '--:--',
    sunset: '--:--',
    lastUpdateHuman: '--:--',
    lastUpdate: '--:--'
  };
});

// Connection management
let clientConnected = false;
let allListeners = [];

// Weather Configuration
const WEATHER_UPDATE_INTERVAL = 10 * 60 * 1000;
let lastWeatherUpdate = 0;

// --- UTILITY FUNCTIONS ---

function formatTime12Hour(timestamp) {
    if (!timestamp) return '--:--:--';
    const d = new Date(timestamp);
    const formatter = new Intl.DateTimeFormat('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit',
        hour12: true 
    });
    return formatter.format(d);
}

function addLogEntry(message, type = 'info', source = 'client') {
    const time = formatTime12Hour(Date.now());
    const typeClass = `log-entry-type-${type.toLowerCase()}`;
    const sourceClass = source === 'device' ? 'log-entry-type-device' : 
                        source === 'rtdb' ? 'log-entry-type-rtdb' :
                        source === 'weather' ? 'log-entry-type-weather' :
                        source === 'automation' ? 'log-entry-type-automation' : '';
    
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    entry.innerHTML = `<span class="log-entry-time">${time}</span><span class="${typeClass} ${sourceClass}">${type.toUpperCase()}:</span> ${message}`;

    logViewer.prepend(entry);
    while (logViewer.children.length > 50) {
        logViewer.removeChild(logViewer.lastChild);
    }
}

// --- DEVICE MANAGEMENT FUNCTIONS ---

function getDevicePath(path) {
  return `HOME/${currentDevice}/${path}`;
}

function switchDevice(deviceId) {
  if (!devices.includes(deviceId)) return;
  
  console.log(`Switching to device: ${deviceId}`);
  
  // Clean up existing listeners
  cleanupListeners();
  
  currentDevice = deviceId;
  
  // Update UI
  deviceTabs.forEach(tab => {
    tab.classList.remove('active-room-1', 'active-room-2', 'active-room-3', 'active-room-4');
    if (tab.dataset.device === deviceId) {
      const roomNum = deviceId.split('_')[1];
      tab.classList.add(`active-room-${roomNum}`);
    }
  });
  
  const displayName = deviceId.replace('_', '-');
  currentDeviceDisplay.textContent = `Controlling: ${displayName}`;
  const roomNum = deviceId.split('_')[1];
  currentDeviceDisplay.className = `current-device room-${roomNum}-theme`;
  
  // Update theme for relays
  updateDeviceTheme();
  
  // Update theme for main tabs, status, and version info
  updateThemeColors();
  
  // Setup new listeners for the current device
  setupDeviceListeners();
  
  // Load schedules for the current device
  loadSchedules();
  
  addLogEntry(`Switched to ${displayName}`, 'info');
}

function updateDeviceTheme() {
  // Update relay buttons theme
  relayBtns.forEach(btn => {
    btn.className = btn.className.replace(/\broom-\d\b/g, '');
    const roomNum = currentDevice.split('_')[1];
    if (btn.classList.contains('on')) {
      btn.classList.add(`room-${roomNum}`);
    }
  });
}

function updateThemeColors() {
  const roomNum = currentDevice.split('_')[1];
  
  // Update main tabs
  const tabBtns = document.querySelectorAll('.tab-btn');
  tabBtns.forEach(btn => {
    // Remove all room-specific active classes
    btn.classList.remove('room-1-active', 'room-2-active', 'room-3-active', 'room-4-active');
    
    // Add the current room's active class to active tabs
    if (btn.classList.contains('active')) {
      btn.classList.add(`room-${roomNum}-active`);
    }
  });
  
  // Update online status
  statusEl.classList.remove('room-1-online', 'room-2-online', 'room-3-online', 'room-4-online');
  if (statusEl.classList.contains('online')) {
    statusEl.classList.add(`room-${roomNum}-online`);
  }
  
  // Update version info colors
  versionInfoEl.className = `dashboard-version room-${roomNum}-version`;
  firmwareInfoEl.className = `firmware-version room-${roomNum}-firmware`;
}

function cleanupListeners() {
  // Remove all existing Firebase listeners
  allListeners.forEach(unsubscribe => {
    if (unsubscribe && typeof unsubscribe === 'function') {
      unsubscribe();
    }
  });
  allListeners = [];
}

function setupDeviceListeners() {
  console.log(`Setting up listeners for ${currentDevice}`);
  
  // Setup relay listeners
  setupRelayListeners();
  
  // Setup device info listeners
  setupDeviceInfoListeners();
  
  // Setup status listeners
  setupStatusListeners();
  
  // Setup switch listeners
  setupSwitchListeners();
}

// --- RELAY CONTROL LOGIC ---

function toggleRelay(index){ 
  if (!clientConnected) {
    addLogEntry('Cannot toggle relay: Client disconnected from Firebase.', 'error');
    return;
  }

  const path = getDevicePath(`relay${index+1}`);
  console.log(`Toggling relay ${index+1} for ${currentDevice}`);
  
  db.ref(path).once('value').then(snap => {
    const newState = !snap.val();
    db.ref(path).set(newState);
    const relayName = relayBtns[index].textContent;
    const stateStr = newState ? 'ON' : 'OFF';
    addLogEntry(`${relayName} manually set to ${stateStr} for ${currentDevice}`, 'relay');
  }).catch(error => {
    addLogEntry(`Failed to read/write relay state: ${error.message}`, 'error');
    console.error('Relay toggle error:', error);
  });
}

function setRelayState(btn, on) { 
  btn.classList.toggle('on', on);
  btn.className = btn.className.replace(/\broom-\d\b/g, '');
  if (on) {
    const roomNum = currentDevice.split('_')[1];
    btn.classList.add(`room-${roomNum}`);
  }
}

function setupRelayListeners() {
  // Clear any existing click listeners by cloning and replacing
  relayBtns.forEach((btn, i) => {
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    relayBtns[i] = newBtn;
  });

  // Add click listeners
  relayBtns.forEach((btn, i) => {
    btn.addEventListener('click', () => toggleRelay(i));
  });

  // Add Firebase listeners for relays
  for (let i = 0; i < 4; i++) {
    const relayPath = getDevicePath(`relay${i+1}`);
    console.log(`Listening to relay path: ${relayPath}`);
    
    const unsubscribe = db.ref(relayPath).on('value', snap => {
      const state = !!snap.val();
      console.log(`Relay ${i+1} state changed to: ${state} for ${currentDevice}`);
      deviceStates[currentDevice].relays[i] = state;
      setRelayState(relayBtns[i], state);
    }, error => {
      console.error(`Error listening to relay ${i+1}:`, error);
    });
    
    allListeners.push(() => db.ref(relayPath).off('value', unsubscribe));
  }
}

function setupDeviceInfoListeners() {
  const paths = [
    { path: 'device/ip', key: 'ip', element: 'ip' },
    { path: 'device/mac', key: 'mac', element: 'mac' },
    { path: 'device/ssid', key: 'ssid', element: 'ssid' },
    { path: 'device/firmwareVersion', key: 'firmware', element: null },
    { path: 'uptime', key: 'uptime', element: 'uptime' },
    { path: 'sunrise', key: 'sunrise', element: 'sunrise' },
    { path: 'sunset', key: 'sunset', element: 'sunset' },
    { path: 'lastUpdateHuman', key: 'lastUpdateHuman', element: 'lastUpdateHuman' },
    { path: 'lastUpdate', key: 'lastUpdate', element: 'lastUpdate' }
  ];

  paths.forEach(({ path, key, element }) => {
    const fullPath = getDevicePath(path);
    console.log(`Listening to device info: ${fullPath}`);
    
    const unsubscribe = db.ref(fullPath).on('value', (snap) => {
      const value = snap.val() || '--';
      deviceStates[currentDevice][key] = value;
      
      // Update UI if this is the current device
      if (element && document.getElementById(element)) {
        document.getElementById(element).textContent = value;
      }
      
      if (key === 'firmware') {
        firmwareInfoEl.textContent = `Firmware: ${value}`;
      }
      
    }, error => {
      console.error(`Error listening to ${path}:`, error);
    });
    
    allListeners.push(() => db.ref(fullPath).off('value', unsubscribe));
  });
}

function setupStatusListeners() {
  // Online status
  const onlineUnsubscribe = db.ref(getDevicePath('online')).on('value', (snap) => {
    const isOnline = snap.val() === true;
    deviceStates[currentDevice].online = isOnline;
    updateStatusDisplay();
  });
  allListeners.push(() => db.ref(getDevicePath('online')).off('value', onlineUnsubscribe));
  
  // Heartbeat via uptime
  const heartbeatUnsubscribe = db.ref(getDevicePath('uptime')).on('value', snap => {
    const val = snap.val(); 
    if(val === null || val === undefined) return; 
    
    deviceStates[currentDevice].lastHeartbeat = Date.now();
    deviceStates[currentDevice].online = true;
    updateStatusDisplay();
  });
  allListeners.push(() => db.ref(getDevicePath('uptime')).off('value', heartbeatUnsubscribe));
}

// --- STATUS DISPLAY LOGIC ---

function updateStatusDisplay() {
  const deviceState = deviceStates[currentDevice];
  const roomNum = currentDevice.split('_')[1];
  
  statusEl.classList.remove('online', 'room-1-online', 'room-2-online', 'room-3-online', 'room-4-online');
  statusEl.style.color = '#fff';
  
  if (!clientConnected) {
    statusEl.textContent = "Client Disconnected";
    statusEl.style.backgroundColor = '#fbbf24';
    statusEl.style.color = '#0f172a';
  } else if (deviceState.online) {
    statusEl.textContent = "Online";
    statusEl.style.backgroundColor = '';
    statusEl.classList.add('online', `room-${roomNum}-online`);
  } else {
    statusEl.textContent = "Offline";
    statusEl.style.backgroundColor = '#ef4444';
  }
}

// --- SWITCH CONTROL FUNCTIONS ---

function setupSwitchListeners() {
  // BEEP state
  const beepUnsubscribe = db.ref(getDevicePath('settings/beepEnabled')).on('value', (snapshot) => {
    const beepState = snapshot.val();
    beepSwitch.classList.toggle('on', beepState === true);
  });
  allListeners.push(() => db.ref(getDevicePath('settings/beepEnabled')).off('value', beepUnsubscribe));
  
  // IR LOCK state
  const irLockUnsubscribe = db.ref(getDevicePath('settings/ir_lock')).on('value', (snapshot) => {
    const irLockState = snapshot.val();
    irLockSwitch.classList.toggle('locked', irLockState === true);
  });
  allListeners.push(() => db.ref(getDevicePath('settings/ir_lock')).off('value', irLockUnsubscribe));
  
  // Button LOCK state
  const buttonLockUnsubscribe = db.ref(getDevicePath('settings/button_lock')).on('value', (snapshot) => {
    const buttonLockState = snapshot.val();
    buttonLockSwitch.classList.toggle('locked', buttonLockState === true);
  });
  allListeners.push(() => db.ref(getDevicePath('settings/button_lock')).off('value', buttonLockUnsubscribe));
}

// BEEP Switch
beepSwitch.addEventListener('click', () => {
  if (!clientConnected) {
    addLogEntry('Cannot toggle BEEP: Client disconnected from Firebase.', 'error');
    return;
  }
  
  const newBeepState = !beepSwitch.classList.contains('on');
  
  db.ref(getDevicePath('settings/beepEnabled')).set(newBeepState)
    .then(() => {
      beepSwitch.classList.toggle('on', newBeepState);
      const statusText = newBeepState ? 'ENABLED' : 'DISABLED';
      addLogEntry(`BEEP ${statusText} for ${currentDevice}`, 'info');
      profileDropdown.classList.remove('show');
    })
    .catch(error => {
      addLogEntry(`Failed to set BEEP state: ${error.message}`, 'error');
    });
});

// IR Lock Switch
irLockSwitch.addEventListener('click', () => {
  if (!clientConnected) {
    addLogEntry('Cannot toggle IR Lock: Client disconnected from Firebase.', 'error');
    return;
  }
  
  const newIrLockState = !irLockSwitch.classList.contains('locked');
  
  db.ref(getDevicePath('settings/ir_lock')).set(newIrLockState)
    .then(() => {
      irLockSwitch.classList.toggle('locked', newIrLockState);
      const statusText = newIrLockState ? 'LOCKED' : 'UNLOCKED';
      addLogEntry(`IR ${statusText} for ${currentDevice}`, 'info');
      profileDropdown.classList.remove('show');
    })
    .catch(error => {
      addLogEntry(`Failed to set IR lock state: ${error.message}`, 'error');
    });
});

// Button Lock Switch
buttonLockSwitch.addEventListener('click', () => {
  if (!clientConnected) {
    addLogEntry('Cannot toggle Button Lock: Client disconnected from Firebase.', 'error');
    return;
  }
  
  const newButtonLockState = !buttonLockSwitch.classList.contains('locked');
  
  db.ref(getDevicePath('settings/button_lock')).set(newButtonLockState)
    .then(() => {
      buttonLockSwitch.classList.toggle('locked', newButtonLockState);
      const statusText = newButtonLockState ? 'LOCKED' : 'UNLOCKED';
      addLogEntry(`Physical Buttons ${statusText} for ${currentDevice}`, 'info');
      profileDropdown.classList.remove('show');
    })
    .catch(error => {
      addLogEntry(`Failed to set button lock state: ${error.message}`, 'error');
    });
});

// Restart Button
restartBtn.addEventListener('click', () => {
  if (!clientConnected) {
    addLogEntry('Cannot send RESTART command: Client disconnected from Firebase.', 'error');
    return;
  }
  
  if (confirm(`Are you sure you want to restart the ${currentDevice} device? This will temporarily disconnect the device.`)) {
    db.ref(getDevicePath('device/rest')).set(true)
      .then(() => {
        addLogEntry(`RESTART command sent to ${currentDevice}`, 'info');
        profileDropdown.classList.remove('show');
        
        setTimeout(() => {
          db.ref(getDevicePath('device/rest')).set(false)
            .catch(error => {
              addLogEntry(`Failed to reset restart flag: ${error.message}`, 'warn');
            });
        }, 4500);
      })
      .catch(error => {
        addLogEntry(`Failed to send RESTART command: ${error.message}`, 'error');
      });
  }
});

// --- WEATHER FUNCTIONS ---

async function fetchWeatherData() {
  try {
    addLogEntry('Fetching weather data from Firebase', 'info', 'weather');
    
    const snapshot = await db.ref('HOME/weather').once('value');
    const weatherData = snapshot.val();
    
    if (!weatherData) {
      throw new Error('No weather data found in Firebase');
    }
    
    addLogEntry('Weather data loaded from Firebase', 'info', 'weather');
    
    return {
      temperature: weatherData.temperature || '--',
      humidity: weatherData.humidity || '--',
      rain: weatherData.rain || false,
      windSpeed: weatherData.windSpeed || '--',
      location: "Weather Station",
      source: "Firebase Realtime Database"
    };
    
  } catch (error) {
    addLogEntry(`Failed to fetch weather data from Firebase: ${error.message}`, 'warn', 'weather');
    return generateDemoWeatherData();
  }
}

function generateDemoWeatherData() {
  const now = new Date();
  const hour = now.getHours();
  
  let baseTemp = 28;
  if (hour >= 22 || hour < 6) baseTemp -= 3;
  if (hour >= 12 && hour < 16) baseTemp += 4;
  
  const temp = baseTemp + Math.floor(Math.random() * 3) - 1;
  
  let baseHumidity = 65;
  if (hour >= 22 || hour < 6) baseHumidity += 15;
  if (hour >= 12 && hour < 16) baseHumidity -= 10;
  
  const humidity = Math.max(40, Math.min(90, baseHumidity + Math.floor(Math.random() * 10) - 5));
  
  const isMonsoon = now.getMonth() >= 5 && now.getMonth() <= 8;
  const rainChance = isMonsoon ? 0.3 : 0.1;
  const isRaining = Math.random() < rainChance;
  
  const windSpeed = 8 + Math.floor(Math.random() * 15);
  
  return {
    temperature: temp,
    humidity: humidity,
    rain: isRaining,
    windSpeed: windSpeed,
    location: "Demo Weather Station",
    source: "Demo Data"
  };
}

async function loadWeatherData() {
  // Disable refresh button during loading
  weatherRefreshBtn.disabled = true;
  weatherRefreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
  
  weatherLocationEl.textContent = 'Loading weather data...';
  temperatureEl.textContent = '--';
  humidityEl.textContent = '--';
  rainStatusEl.textContent = '--';
  windSpeedEl.textContent = '--';
  weatherSourceEl.textContent = '';
  
  const existingError = document.querySelector('.weather-error');
  if (existingError) existingError.remove();

  try {
    const weatherData = await fetchWeatherData();
    
    temperatureEl.textContent = weatherData.temperature;
    humidityEl.textContent = weatherData.humidity;
    rainStatusEl.textContent = weatherData.rain ? 'Raining' : 'Not Raining';
    windSpeedEl.textContent = weatherData.windSpeed;
    weatherLocationEl.textContent = weatherData.location;
    weatherSourceEl.textContent = `Source: ${weatherData.source}`;
    
    lastWeatherUpdate = Date.now();
    
    addLogEntry(`Weather data updated: ${weatherData.temperature}°C, ${weatherData.humidity}% humidity`, 'info', 'weather');
    
  } catch (error) {
    console.error('Weather loading error:', error);
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'weather-error';
    errorDiv.textContent = 'Weather service temporarily unavailable. Using demo data.';
    weatherLocationEl.after(errorDiv);
    
    const demoData = generateDemoWeatherData();
    temperatureEl.textContent = demoData.temperature;
    humidityEl.textContent = demoData.humidity;
    rainStatusEl.textContent = demoData.rain ? 'Raining' : 'Not Raining';
    windSpeedEl.textContent = demoData.windSpeed;
    weatherLocationEl.textContent = demoData.location;
    weatherSourceEl.textContent = `Source: ${demoData.source}`;

    addLogEntry(`All weather services failed: ${error.message}`, 'error', 'weather');
  } finally {
    // Re-enable refresh button
    weatherRefreshBtn.disabled = false;
    weatherRefreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Weather Data';
  }
}

// Weather Refresh Button Event Listener
weatherRefreshBtn.addEventListener('click', loadWeatherData);

// --- NEW: NEXT EXECUTION TIME CALCULATION ---

function calculateNextExecutionTime(schedule) {
  if (!schedule.enabled) return 'Schedule disabled';
  
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
  // Get sunrise and sunset times from device state
  const deviceState = deviceStates[currentDevice];
  
  // Check if we have valid sunrise/sunset data
  if (!deviceState.sunrise || deviceState.sunrise === '--:--' || 
      !deviceState.sunset || deviceState.sunset === '--:--') {
    return 'No sunrise/sunset data';
  }
  
  let baseTime = null;
  
  if (schedule.type === 'sunrise') {
    const [hours, minutes] = deviceState.sunrise.split(':').map(Number);
    baseTime = new Date(today);
    baseTime.setHours(hours, minutes, 0, 0);
  } else if (schedule.type === 'sunset') {
    const [hours, minutes] = deviceState.sunset.split(':').map(Number);
    baseTime = new Date(today);
    baseTime.setHours(hours, minutes, 0, 0);
  }
  
  if (!baseTime) return 'Unknown schedule type';
  
  // Apply offset (in minutes)
  const offsetMs = (schedule.offset || 0) * 60 * 1000;
  const executionTime = new Date(baseTime.getTime() + offsetMs);
  
  // If the execution time has already passed today, calculate for tomorrow
  if (executionTime < now) {
    executionTime.setDate(executionTime.getDate() + 1);
  }
  
  return formatTime12Hour(executionTime);
}

// --- AUTOMATION SCHEDULE FUNCTIONS ---

function showScheduleForm(scheduleData = null) {
    const isEdit = scheduleData !== null;
    const scheduleId = scheduleData?.id || getNextAvailableScheduleId();
    
    // Calculate next execution time for display in form
    let nextExecutionDisplay = 'Will be calculated after save';
    if (isEdit && (scheduleData.type === 'sunrise' || scheduleData.type === 'sunset')) {
        nextExecutionDisplay = calculateNextExecutionTime(scheduleData);
    }
    
    const formHTML = `
        <div class="schedule-form">
            <h3 style="color: #38bdf8; margin-bottom: 15px;">${isEdit ? 'Edit Schedule' : 'Add New Schedule'}</h3>
            
            <div class="form-group">
                <label class="form-label">Schedule Name</label>
                <input type="text" id="scheduleName" class="form-input" value="${isEdit ? scheduleData.name : ''}" placeholder="Enter schedule name">
            </div>
            
            <div class="form-group">
                <label class="form-label">Schedule Type</label>
                <select id="scheduleType" class="form-select">
                    <option value="daily" ${isEdit && scheduleData.type === 'daily' ? 'selected' : ''}>Daily Time-based</option>
                    <option value="weekly" ${isEdit && scheduleData.type === 'weekly' ? 'selected' : ''}>Weekly Time-based</option>
                    <option value="sunrise" ${isEdit && scheduleData.type === 'sunrise' ? 'selected' : ''}>Sunrise with Offset</option>
                    <option value="sunset" ${isEdit && scheduleData.type === 'sunset' ? 'selected' : ''}>Sunset with Offset</option>
                    <option value="temperature" ${isEdit && scheduleData.type === 'temperature' ? 'selected' : ''}>Temperature-based</option>
                    <option value="timer" ${isEdit && scheduleData.type === 'timer' ? 'selected' : ''}>Timer</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Relay</label>
                <select id="scheduleRelay" class="form-select">
                    <option value="1" ${isEdit && scheduleData.relay === 1 ? 'selected' : ''}>Relay 1 (FAN)</option>
                    <option value="2" ${isEdit && scheduleData.relay === 2 ? 'selected' : ''}>Relay 2 (LIGHT)</option>
                    <option value="3" ${isEdit && scheduleData.relay === 3 ? 'selected' : ''}>Relay 3 (FAN-2)</option>
                    <option value="4" ${isEdit && scheduleData.relay === 4 ? 'selected' : ''}>Relay 4 (DIM-L)</option>
                </select>
            </div>
            
            <div id="triggerFields" class="trigger-fields">
                ${renderTriggerFields(scheduleData)}
            </div>
            
            <div class="form-group">
                <label class="form-label">Action</label>
                <select id="actionSelect" class="form-select">
                    <option value="true" ${isEdit && scheduleData.action === true ? 'selected' : ''}>Turn ON</option>
                    <option value="false" ${isEdit && scheduleData.action === false ? 'selected' : ''}>Turn OFF</option>
                </select>
            </div>
            
            ${(scheduleData?.type === 'sunrise' || scheduleData?.type === 'sunset') ? `
            <div class="form-group">
                <label class="form-label">Next Execution</label>
                <div class="next-execution">${nextExecutionDisplay}</div>
            </div>
            ` : ''}
            
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="scheduleEnabled" ${isEdit && scheduleData.enabled !== false ? 'checked' : ''}>
                    Enable Schedule
                </label>
            </div>
            
            <div class="form-actions">
                <button class="cancel-btn" id="cancelScheduleBtn">Cancel</button>
                <button class="save-btn" id="saveScheduleBtn">Save Schedule</button>
            </div>
        </div>
    `;
    
    scheduleFormContainer.innerHTML = formHTML;
    scheduleFormContainer.style.display = 'block';
    
    // Add event listeners
    document.getElementById('cancelScheduleBtn').addEventListener('click', hideScheduleForm);
    document.getElementById('saveScheduleBtn').addEventListener('click', () => saveSchedule(scheduleId));
    document.getElementById('scheduleType').addEventListener('change', updateTriggerFields);
    
    // Scroll to form
    scheduleFormContainer.scrollIntoView({ behavior: 'smooth' });
}

function getNextAvailableScheduleId() {
    for (let i = 1; i <= 50; i++) {
        if (!document.querySelector(`[data-schedule-id="${i}"]`)) {
            return i;
        }
    }
    return 1;
}

function renderTriggerFields(scheduleData) {
    const scheduleType = scheduleData?.type || 'daily';
    
    switch(scheduleType) {
        case 'daily':
            return `
                <div class="form-group">
                    <label class="form-label">ON Time</label>
                    <input type="time" id="onTime" class="form-input" value="${scheduleData?.onTime || '07:00'}">
                </div>
                <div class="form-group">
                    <label class="form-label">OFF Time</label>
                    <input type="time" id="offTime" class="form-input" value="${scheduleData?.offTime || '18:00'}">
                </div>
            `;
        case 'weekly':
            return `
                <div class="form-group">
                    <label class="form-label">ON Time</label>
                    <input type="time" id="onTime" class="form-input" value="${scheduleData?.onTime || '07:00'}">
                </div>
                <div class="form-group">
                    <label class="form-label">OFF Time</label>
                    <input type="time" id="offTime" class="form-input" value="${scheduleData?.offTime || '18:00'}">
                </div>
                <div class="form-group">
                    <label class="form-label">Days (0=Sun, 1=Mon, ..., 6=Sat)</label>
                    <input type="text" id="days" class="form-input" value="${scheduleData?.days || '1,2,3,4,5'}" placeholder="e.g., 1,2,3,4,5">
                    <small style="color: #94a3b8;">Comma-separated day numbers (0-6)</small>
                </div>
            `;
        case 'sunrise':
        case 'sunset':
            const offset = scheduleData?.offset || 0;
            return `
                <div class="form-group">
                    <label class="form-label">Offset (minutes)</label>
                    <input type="number" id="sunOffset" class="form-input" value="${offset}" min="-120" max="120" step="1">
                    <small style="color: #94a3b8;">Positive for after ${scheduleType}, negative for before ${scheduleType}</small>
                </div>
            `;
        case 'temperature':
            const condition = scheduleData?.condition || '>';
            const tempValue = scheduleData?.value || 25;
            return `
                <div class="form-group">
                    <label class="form-label">Condition</label>
                    <select id="tempCondition" class="form-select">
                        <option value=">" ${condition === '>' ? 'selected' : ''}>Temperature Above</option>
                        <option value="<" ${condition === '<' ? 'selected' : ''}>Temperature Below</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Temperature Value (°C)</label>
                    <input type="number" id="tempValue" class="form-input" value="${tempValue}" min="-10" max="50" step="0.5" placeholder="Enter temperature">
                </div>
            `;
        case 'timer':
            return `
                <div class="form-group">
                    <label class="form-label">Duration (minutes)</label>
                    <input type="number" id="duration" class="form-input" value="${scheduleData?.duration || 30}" min="1" max="1440">
                </div>
            `;
        default:
            return '';
    }
}

function updateTriggerFields() {
    const scheduleType = document.getElementById('scheduleType').value;
    const triggerFields = document.getElementById('triggerFields');
    
    const tempScheduleData = { type: scheduleType };
    triggerFields.innerHTML = renderTriggerFields(tempScheduleData);
}

function hideScheduleForm() {
    scheduleFormContainer.style.display = 'none';
    scheduleFormContainer.innerHTML = '';
}

function saveSchedule(scheduleId) {
    if (!clientConnected) {
        addLogEntry('Cannot save schedule: Client disconnected from Firebase.', 'error');
        return;
    }

    const scheduleType = document.getElementById('scheduleType').value;
    const name = document.getElementById('scheduleName').value;
    const relay = parseInt(document.getElementById('scheduleRelay').value);
    const action = document.getElementById('actionSelect').value === 'true';
    const enabled = document.getElementById('scheduleEnabled').checked;

    if (!name.trim()) {
        alert('Please enter a schedule name');
        return;
    }

    if (relay < 1 || relay > 4) {
        alert('Please select a valid relay (1-4)');
        return;
    }

    const scheduleData = {
        name: name,
        enabled: enabled,
        type: scheduleType,
        relay: relay,
        action: action
    };

    // Add type-specific data
    if (scheduleType === 'daily' || scheduleType === 'weekly') {
        const onTime = document.getElementById('onTime').value;
        const offTime = document.getElementById('offTime').value;
        
        if (!onTime || !offTime) {
            alert('Please enter both ON and OFF times');
            return;
        }
        
        scheduleData.onTime = onTime;
        scheduleData.offTime = offTime;
        
        if (scheduleType === 'weekly') {
            const days = document.getElementById('days').value;
            if (!days.trim()) {
                alert('Please enter days for weekly schedule');
                return;
            }
            scheduleData.days = days;
        }
    } else if (scheduleType === 'sunrise' || scheduleType === 'sunset') {
        const offset = parseInt(document.getElementById('sunOffset').value) || 0;
        scheduleData.offset = offset;
        
        // Calculate next execution time
        scheduleData.nextExecution = calculateNextExecutionTime(scheduleData);
    } else if (scheduleType === 'temperature') {
        const condition = document.getElementById('tempCondition').value;
        const value = parseFloat(document.getElementById('tempValue').value);
        if (isNaN(value)) {
            alert('Please enter a valid temperature');
            return;
        }
        scheduleData.condition = condition;
        scheduleData.value = value;
    } else if (scheduleType === 'timer') {
        const duration = parseInt(document.getElementById('duration').value);
        
        if (isNaN(duration) || duration < 1) {
            alert('Please enter a valid duration');
            return;
        }
        
        scheduleData.duration = duration;
    }

    const path = getDevicePath(`automation/schedule${scheduleId}`);
    
    db.ref(path).set(scheduleData)
        .then(() => {
            addLogEntry(`Schedule "${name}" ${scheduleData.enabled ? 'created/enabled' : 'created/disabled'} for ${currentDevice}`, 'automation', 'automation');
            hideScheduleForm();
            loadSchedules();
        })
        .catch(error => {
            addLogEntry(`Failed to save schedule: ${error.message}`, 'error');
            alert('Failed to save schedule: ' + error.message);
        });
}

function deleteSchedule(scheduleId) {
    if (!clientConnected) {
        addLogEntry('Cannot delete schedule: Client disconnected from Firebase.', 'error');
        return;
    }

    if (confirm('Are you sure you want to delete this schedule?')) {
        db.ref(getDevicePath(`automation/schedule${scheduleId}`)).remove()
            .then(() => {
                addLogEntry(`Schedule deleted from ${currentDevice}`, 'automation', 'automation');
                loadSchedules();
            })
            .catch(error => {
                addLogEntry(`Failed to delete schedule: ${error.message}`, 'error');
            });
    }
}

function toggleSchedule(scheduleId, currentState) {
    if (!clientConnected) {
        addLogEntry('Cannot toggle schedule: Client disconnected from Firebase.', 'error');
        return;
    }

    const newState = !currentState;
    
    db.ref(getDevicePath(`automation/schedule${scheduleId}/enabled`)).set(newState)
        .then(() => {
            const statusText = newState ? 'ENABLED' : 'DISABLED';
            addLogEntry(`Schedule ${statusText} for ${currentDevice}`, 'automation', 'automation');
            loadSchedules();
        })
        .catch(error => {
            addLogEntry(`Failed to toggle schedule: ${error.message}`, 'error');
        });
}

function loadSchedules() {
    // Load all schedules (schedule1 to schedule50) for current device
    const schedulePromises = [];
    
    for (let i = 1; i <= 50; i++) {
        schedulePromises.push(
            db.ref(getDevicePath(`automation/schedule${i}`)).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        return { id: i, ...snapshot.val() };
                    }
                    return null;
                })
        );
    }
    
    Promise.all(schedulePromises)
        .then((schedules) => {
            const validSchedules = schedules.filter(schedule => schedule !== null);
            displaySchedules(validSchedules);
        })
        .catch(error => {
            addLogEntry(`Failed to load schedules: ${error.message}`, 'error');
        });
}

function displaySchedules(schedules) {
    schedulesList.innerHTML = '';
    
    if (schedules.length === 0) {
        schedulesList.innerHTML = `
            <div class="schedule-card">
                <div style="text-align: center; color: #94a3b8; padding: 20px;">
                    No schedules found for ${currentDevice}. Click "Add Schedule" to create your first automation.
                </div>
            </div>
        `;
        return;
    }
    
    schedules.sort((a, b) => a.id - b.id);
    
    schedules.forEach(schedule => {
        const card = document.createElement('div');
        card.className = `schedule-card ${schedule.enabled ? 'enabled' : 'disabled'}`;
        card.setAttribute('data-schedule-id', schedule.id);
        
        let triggerText = '';
        switch(schedule.type) {
            case 'daily':
                triggerText = `Daily: ON at ${schedule.onTime}, OFF at ${schedule.offTime}`;
                break;
            case 'weekly':
                triggerText = `Weekly: ON at ${schedule.onTime}, OFF at ${schedule.offTime} on days ${schedule.days}`;
                break;
            case 'sunrise':
                triggerText = `Sunrise ${schedule.offset >= 0 ? '+' : ''}${schedule.offset} minutes: ${schedule.action ? 'ON' : 'OFF'}`;
                break;
            case 'sunset':
                triggerText = `Sunset ${schedule.offset >= 0 ? '+' : ''}${schedule.offset} minutes: ${schedule.action ? 'ON' : 'OFF'}`;
                break;
            case 'temperature':
                triggerText = `Temperature ${schedule.condition} ${schedule.value}°C: ${schedule.action ? 'ON' : 'OFF'}`;
                break;
            case 'timer':
                triggerText = `Timer: ${schedule.duration} minutes`;
                break;
        }
        
        const relayNames = ['FAN', 'LIGHT', 'FAN-2', 'DIM-L'];
        const actionText = schedule.action ? 'ON' : 'OFF';
        
        // Calculate next execution time for sunrise/sunset schedules
        let nextExecutionHTML = '';
        if ((schedule.type === 'sunrise' || schedule.type === 'sunset') && schedule.enabled) {
            const nextExecution = calculateNextExecutionTime(schedule);
            nextExecutionHTML = `<div class="schedule-trigger"><strong>Next Execution:</strong> <span class="next-execution">${nextExecution}</span></div>`;
        }
        
        card.innerHTML = `
            <div class="schedule-header">
                <div class="schedule-name">${schedule.name} (Schedule${schedule.id})</div>
                <div class="schedule-actions">
                    <button class="schedule-action-btn toggle-btn" data-schedule-id="${schedule.id}" data-current-state="${schedule.enabled}" title="${schedule.enabled ? 'Disable' : 'Enable'}">
                        <i class="fas ${schedule.enabled ? 'fa-pause' : 'fa-play'}"></i>
                    </button>
                    <button class="schedule-action-btn edit-btn" data-schedule-id="${schedule.id}" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="schedule-action-btn delete-btn" data-schedule-id="${schedule.id}" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="schedule-details">
                <div class="schedule-trigger"><strong>Trigger:</strong> ${triggerText}</div>
                <div class="schedule-action"><strong>Action:</strong> ${relayNames[schedule.relay - 1]} ${actionText}</div>
                ${nextExecutionHTML}
                <div class="schedule-status"><strong>Status:</strong> ${schedule.enabled ? 'Enabled' : 'Disabled'}</div>
            </div>
        `;
        
        schedulesList.appendChild(card);
    });

    // Add event listeners to the buttons
    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const scheduleId = e.target.closest('.toggle-btn').getAttribute('data-schedule-id');
            const currentState = e.target.closest('.toggle-btn').getAttribute('data-current-state') === 'true';
            toggleSchedule(parseInt(scheduleId), currentState);
        });
    });

    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const scheduleId = e.target.closest('.edit-btn').getAttribute('data-schedule-id');
            editSchedule(parseInt(scheduleId));
        });
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const scheduleId = e.target.closest('.delete-btn').getAttribute('data-schedule-id');
            deleteSchedule(parseInt(scheduleId));
        });
    });
}

function editSchedule(scheduleId) {
    db.ref(getDevicePath(`automation/schedule${scheduleId}`)).once('value')
        .then((snapshot) => {
            const scheduleData = snapshot.val();
            if (scheduleData) {
                scheduleData.id = scheduleId;
                showScheduleForm(scheduleData);
            }
        })
        .catch(error => {
            addLogEntry(`Failed to load schedule for editing: ${error.message}`, 'error');
        });
}

// Add schedule button event listener
addScheduleBtn.addEventListener('click', () => {
    showScheduleForm();
});

// --- AUTHENTICATION & SESSION LOGIC ---

function showLogin() {
    dashboardContainer.style.display = 'none';
    loginScreen.style.display = 'flex';
}

function showDashboard(user) {
    localStorage.setItem(SESSION_KEY, 'true');
    userEmailDisplay.textContent = user.email;
    loginScreen.style.display = 'none';
    dashboardContainer.style.display = 'block';
    
    addLogEntry(`Multi-room dashboard ${DASHBOARD_VERSION} initialized`, 'info');
    
    // Initialize the current device
    setupDeviceListeners();
    
    // Set version info
    versionInfoEl.textContent = `Dashboard: ${DASHBOARD_VERSION}`;
    
    // Load initial weather data
    loadWeatherData();
}

function handleAuthError(error) {
    loginError.textContent = error.message.replace('Firebase: ', '');
    addLogEntry(`Authentication failed: ${error.code}`, 'error');
}

// Check for existing session
if (localStorage.getItem(SESSION_KEY) === 'true') {
    showDashboard({ email: 'Checking session...' }); 
} else {
    showLogin();
}

// Auth state listener
auth.onAuthStateChanged((user) => {
    if (user) {
        showDashboard(user);
        addLogEntry(`User ${user.email} signed in successfully.`, 'info');
        loadSchedules(); // Load automation schedules
    } else {
        if (localStorage.getItem(SESSION_KEY) === 'true') {
            localStorage.removeItem(SESSION_KEY);
            addLogEntry('Session expired. Please log in again.', 'warn');
        }
        showLogin();
    }
});

// Login button event
loginBtn.addEventListener('click', async () => {
    loginError.textContent = '';
    try {
        await auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value);
    } catch (error) {
        handleAuthError(error);
    }
});

// Create account button event
createAccountBtn.addEventListener('click', async () => {
    loginError.textContent = '';
    if (!loginEmail.value || !loginPassword.value) {
        loginError.textContent = 'Please enter both email and password.';
        return;
    }
    try {
        await auth.createUserWithEmailAndPassword(loginEmail.value, loginPassword.value);
    } catch (error) {
        handleAuthError(error);
    }
});

// Logout button event
logoutBtn.addEventListener('click', async () => {
    try {
        await auth.signOut();
        localStorage.removeItem(SESSION_KEY); 
        addLogEntry('User logged out.', 'info');
    } catch (error) {
        handleAuthError(error);
    }
});

// Profile menu toggle
profileBtn.addEventListener('click', (event) => {
    event.stopPropagation();
    profileDropdown.classList.toggle('show');
});
window.addEventListener('click', (event) => {
    if (!event.target.matches('#profileBtn') && !event.target.closest('.dropdown-content')) {
        if (profileDropdown.classList.contains('show')) {
            profileDropdown.classList.remove('show');
        }
    }
});

// --- DEVICE SWITCHING EVENT LISTENERS ---

deviceTabs.forEach(tab => {
  tab.addEventListener('click', () => {
    switchDevice(tab.dataset.device);
  });
});

// --- TAB NAVIGATION LOGIC ---
const tabs = document.querySelectorAll('.tab-btn');
const contents = document.querySelectorAll('.tab-content');
tabs.forEach(btn => {
  btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('active'));
    contents.forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
    
    // Update tab theme colors
    updateThemeColors();
    
    // Load schedules when switching to automation tab
    if (btn.dataset.tab === 'automation') {
        loadSchedules();
    }
    
    // Load weather when switching to weather tab
    if (btn.dataset.tab === 'weather') {
        loadWeatherData();
    }
  });
});

// --- FIREBASE CONNECTION LISTENER ---

db.ref('.info/connected').on('value', (snap) => {
    const wasConnected = clientConnected;
    clientConnected = snap.val();
    
    if (clientConnected && !wasConnected) {
        addLogEntry('Client connected to Firebase.', 'info');
        // Re-initialize listeners when reconnecting
        setupDeviceListeners();
    } else if (!clientConnected && wasConnected) {
        addLogEntry('Client lost connection to Firebase.', 'error');
    }
    updateStatusDisplay();
});

// --- INITIALIZATION ---

// Set initial device and initialize
switchDevice('ROOM_1');

addLogEntry('Multi-room dashboard initialized successfully. Ready to control 4 devices.', 'info');

</script>
</body>
</html>
